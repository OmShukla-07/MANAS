{% extends 'student/base_student.html' %}
{% load static %}

{% block title %}MANAS AI - Chat Assistant{% endblock %}

{% block header_title %}MANAS AI{% endblock %}

{% block extra_css %}
<meta name="csrf-token" content="{{ csrf_token }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="{% static 'css/crisis_popup.css' %}">
<style>
    .manas-ai-container {
        height: calc(100vh - 120px);
        display: flex;
        flex-direction: column;
        background: linear-gradient(180deg, #f5f7fa 0%, #e8f2ed 50%, #f8fafc 100%);
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 10px 40px rgba(89, 137, 128, 0.1);
        position: relative;
    }

    .manas-ai-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #598980, #7ba399, #4ca1af, #7ba399, #598980);
        background-size: 200% 100%;
        animation: shimmer 3s linear infinite;
    }

    @keyframes shimmer {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }

    .manas-header {
        background: linear-gradient(135deg, rgba(89, 137, 128, 0.05), rgba(123, 163, 153, 0.05));
        backdrop-filter: blur(20px);
        padding: 16px 20px;
        text-align: center;
        border-bottom: 1px solid rgba(89, 137, 128, 0.1);
        position: relative;
    }

    .language-controls {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        margin-top: 10px;
    }

    .language-selector {
        display: flex;
        align-items: center;
        gap: 8px;
        background: white;
        padding: 8px 14px;
        border-radius: 20px;
        border: 2px solid rgba(89, 137, 128, 0.2);
        transition: all 0.3s ease;
    }

    .language-selector:hover {
        border-color: #598980;
        box-shadow: 0 2px 12px rgba(89, 137, 128, 0.15);
    }

    .language-icon {
        font-size: 16px;
    }

    #languageSelector {
        border: none;
        outline: none;
        background: transparent;
        color: #1e293b;
        font-weight: 500;
        font-size: 14px;
        cursor: pointer;
        padding-right: 8px;
    }

    .translate-toggle {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 8px 16px;
        background: linear-gradient(135deg, #598980, #7ba399);
        color: white;
        border: none;
        border-radius: 20px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 500;
        transition: all 0.3s ease;
        box-shadow: 0 2px 12px rgba(89, 137, 128, 0.3);
    }

    .translate-toggle:hover {
        background: linear-gradient(135deg, #4a7670, #598980);
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(89, 137, 128, 0.4);
    }

    .translate-toggle.active {
        background: linear-gradient(135deg, #4ca1af, #7ba399);
    }

    .translate-toggle i {
        font-size: 14px;
    }

    .translate-btn {
        background: transparent;
        border: none;
        color: #598980;
        cursor: pointer;
        padding: 4px 8px;
        font-size: 12px;
        border-radius: 12px;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 4px;
        margin-top: 6px;
    }

    .translate-btn:hover {
        background: rgba(89, 137, 128, 0.1);
        color: #4a7670;
    }

    .translate-btn i {
        font-size: 11px;
    }

    .chat-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: white;
        margin: 16px;
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(89, 137, 128, 0.08);
        border: 1px solid rgba(89, 137, 128, 0.1);
    }

    .chat-messages {
        flex: 1;
        padding: 24px;
        overflow-y: auto;
        background: linear-gradient(180deg, #ffffff 0%, #fafbfc 100%);
        scroll-behavior: smooth;
    }

    .chat-messages::-webkit-scrollbar {
        width: 8px;
    }

    .chat-messages::-webkit-scrollbar-track {
        background: rgba(89, 137, 128, 0.05);
        border-radius: 10px;
    }

    .chat-messages::-webkit-scrollbar-thumb {
        background: linear-gradient(180deg, #598980, #7ba399);
        border-radius: 10px;
    }

    .chat-messages::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(180deg, #4a7670, #598980);
    }

    .message {
        margin-bottom: 20px;
        display: flex;
        align-items: flex-start;
        gap: 12px;
        animation: messageSlide 0.3s ease-out;
    }

    @keyframes messageSlide {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .message.user {
        flex-direction: row-reverse;
    }

    .message-avatar {
        width: 42px;
        height: 42px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 22px;
        flex-shrink: 0;
        position: relative;
        overflow: hidden;
        background-size: contain;
        background-position: center;
        background-repeat: no-repeat;
        background-color: transparent;
    }

    .message.user .message-avatar {
        background: linear-gradient(135deg, #598980, #7ba399);
        box-shadow: 0 4px 12px rgba(89, 137, 128, 0.2);
        color: white;
        font-weight: 600;
        font-size: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .message.ai .message-avatar {
        background-image: url("{% static 'images/images/icons/manas-ai-icon.png' %}");
        box-shadow: 0 4px 12px rgba(89, 137, 128, 0.2);
    }

    .message-bubble {
        max-width: 70%;
        padding: 14px 18px;
        border-radius: 20px;
        position: relative;
        line-height: 1.6;
        font-size: 15px;
    }

    .message.user .message-bubble {
        background: linear-gradient(135deg, #598980, #7ba399);
        color: white;
        border-bottom-right-radius: 6px;
        box-shadow: 0 4px 16px rgba(89, 137, 128, 0.25);
    }

    .message.ai .message-bubble {
        background: white;
        color: #1e293b;
        border: 1px solid rgba(89, 137, 128, 0.15);
        border-bottom-left-radius: 6px;
        box-shadow: 0 2px 12px rgba(89, 137, 128, 0.1);
    }

    .message-timestamp {
        font-size: 11px;
        opacity: 0.7;
        margin-top: 6px;
        font-weight: 500;
    }

    .typing-indicator {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 14px 18px;
        background: white;
        border: 1px solid rgba(89, 137, 128, 0.15);
        border-radius: 20px;
        border-bottom-left-radius: 6px;
        box-shadow: 0 2px 12px rgba(89, 137, 128, 0.1);
    }

    .typing-dots {
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .typing-dots span {
        height: 10px;
        width: 10px;
        background: linear-gradient(135deg, #598980, #7ba399);
        border-radius: 50%;
        animation: typing 1.4s infinite ease-in-out;
        box-shadow: 0 2px 6px rgba(89, 137, 128, 0.3);
    }

    .typing-dots span:nth-child(1) { animation-delay: 0s; }
    .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
    .typing-dots span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typing {
        0%, 60%, 100% { 
            transform: translateY(0) scale(1); 
            opacity: 0.4; 
        }
        30% { 
            transform: translateY(-12px) scale(1.1); 
            opacity: 1; 
        }
    }

    .chat-input-container {
        padding: 20px 24px;
        background: linear-gradient(180deg, #ffffff, #fafbfc);
        border-top: 1px solid rgba(89, 137, 128, 0.1);
    }

    .input-group {
        display: flex;
        gap: 12px;
        align-items: center;
        background: white;
        border: 2px solid rgba(89, 137, 128, 0.15);
        border-radius: 30px;
        padding: 6px 6px 6px 20px;
        transition: all 0.3s ease;
        box-shadow: 0 2px 12px rgba(89, 137, 128, 0.08);
    }

    .input-group:focus-within {
        border-color: #598980;
        box-shadow: 0 4px 20px rgba(89, 137, 128, 0.15);
        transform: translateY(-2px);
    }

    .chat-input {
        flex: 1;
        padding: 10px 0;
        border: none;
        outline: none;
        font-size: 15px;
        background: transparent;
        color: #1e293b;
    }

    .chat-input::placeholder {
        color: #94a3b8;
    }

    .send-btn {
        width: 48px;
        height: 48px;
        border: none;
        border-radius: 50%;
        background: linear-gradient(135deg, #598980, #7ba399);
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        box-shadow: 0 4px 16px rgba(89, 137, 128, 0.3);
        font-size: 18px;
    }

    .send-btn:hover:not(:disabled) {
        background: linear-gradient(135deg, #4a7670, #598980);
        transform: scale(1.08) rotate(5deg);
        box-shadow: 0 6px 20px rgba(89, 137, 128, 0.4);
    }

    .send-btn:active:not(:disabled) {
        transform: scale(0.95);
    }

    .send-btn:disabled {
        background: linear-gradient(135deg, #cbd5e1, #94a3b8);
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    .history-panel {
        position: fixed;
        right: -370px;
        top: 0;
        width: 370px;
        height: 100vh;
        background: linear-gradient(180deg, rgba(255,255,255,0.98) 0%, rgba(248,250,252,0.98) 100%);
        backdrop-filter: blur(20px);
        box-shadow: -8px 0 32px rgba(89, 137, 128, 0.12);
        transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 1000;
        display: flex;
        flex-direction: column;
        border-left: 1px solid rgba(89, 137, 128, 0.15);
    }

    .history-panel.open {
        right: 0;
    }

    .history-header {
        padding: 24px 20px;
        background: linear-gradient(135deg, #598980, #7ba399);
        border-bottom: none;
        position: relative;
        overflow: hidden;
    }

    .history-header::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
        animation: rotate 20s linear infinite;
    }

    @keyframes rotate {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .history-header h3 {
        color: white;
        margin: 0;
        font-size: 18px;
        font-weight: 600;
        position: relative;
        z-index: 2;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .history-header h3::before {
        content: 'üí¨';
        font-size: 22px;
    }

    .new-chat-btn {
        background: rgba(255,255,255,0.25);
        border: 1px solid rgba(255,255,255,0.3);
        color: white;
        padding: 8px 16px;
        border-radius: 12px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 500;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .new-chat-btn:hover {
        background: rgba(255,255,255,0.35);
        transform: translateY(-2px);
    }

    .history-close-btn {
        background: rgba(255,255,255,0.25);
        border: 1px solid rgba(255,255,255,0.3);
        color: white;
        width: 36px;
        height: 36px;
        border-radius: 12px;
        cursor: pointer;
        font-size: 20px;
        transition: all 0.2s;
        z-index: 3;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-left: 10px;
    }

    .history-close-btn:hover {
        background: rgba(255,255,255,0.35);
        transform: scale(1.05);
    }

    .history-content {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        background: rgba(255,255,255,0.5);
    }

    .history-content::-webkit-scrollbar {
        width: 6px;
    }

    .history-content::-webkit-scrollbar-track {
        background: rgba(89, 137, 128, 0.08);
        border-radius: 3px;
    }

    .history-content::-webkit-scrollbar-thumb {
        background: linear-gradient(180deg, #598980, #7ba399);
        border-radius: 3px;
    }

    .history-content::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(180deg, #4a7670, #598980);
    }

    .history-section {
        margin-bottom: 25px;
        position: relative;
    }

    .session-item {
        background: white;
        border-radius: 16px;
        border: 1px solid rgba(89, 137, 128, 0.12);
        margin-bottom: 12px;
        transition: all 0.3s ease;
        overflow: hidden;
    }

    .session-item:hover {
        border-color: #598980;
        box-shadow: 0 4px 16px rgba(89, 137, 128, 0.15);
        transform: translateX(-4px);
    }

    .session-item.current-session {
        border-color: #4ca1af;
        background: linear-gradient(135deg, rgba(76, 161, 175, 0.08), rgba(89, 137, 128, 0.08));
    }

    .session-header {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        padding: 14px 16px;
    }

    .session-info {
        flex: 1;
        cursor: pointer;
    }

    .session-title {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 8px;
    }

    .session-companion {
        font-weight: 600;
        color: #0f172a;
        font-size: 14px;
    }

    .session-time {
        font-size: 11px;
        color: #64748b;
        font-weight: 500;
    }

    .session-preview {
        color: #475569;
        font-size: 13px;
        line-height: 1.5;
        margin-bottom: 4px;
    }

    .session-meta {
        font-size: 11px;
        color: #64748b;
    }

    .history-section h4 {
        color: #598980;
        font-size: 15px;
        font-weight: 600;
        margin-bottom: 14px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding-bottom: 10px;
        border-bottom: 2px solid rgba(89, 137, 128, 0.15);
        gap: 8px;
    }

    .history-item {
        padding: 16px;
        margin-bottom: 12px;
        background: white;
        border-radius: 16px;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 1px solid rgba(89, 137, 128, 0.12);
        position: relative;
        overflow: hidden;
    }

    .history-item::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        background: linear-gradient(180deg, #598980, #7ba399);
        transform: scaleY(0);
        transition: transform 0.3s ease;
    }

    .history-item:hover {
        background: rgba(89, 137, 128, 0.05);
        transform: translateX(-6px);
        box-shadow: 0 4px 16px rgba(89, 137, 128, 0.12);
        border-color: #598980;
    }

    .history-item:hover::before {
        transform: scaleY(1);
    }

    .history-message {
        font-size: 14px;
        line-height: 1.5;
        margin-bottom: 8px;
        color: #0f172a;
    }

    .history-message strong {
        color: #598980;
        font-weight: 600;
    }

    .history-time {
        font-size: 12px;
        color: #64748b;
        display: flex;
        align-items: center;
        gap: 6px;
        font-weight: 500;
    }

    .history-time::before {
        content: 'üïí';
        font-size: 11px;
    }

    .history-empty {
        text-align: center;
        padding: 60px 20px;
        color: #64748b;
    }

    .history-empty-icon {
        font-size: 56px;
        margin-bottom: 16px;
        opacity: 0.4;
    }

    .history-toggle {
        position: fixed;
        right: 24px;
        top: 50%;
        transform: translateY(-50%);
        background: linear-gradient(135deg, #598980, #7ba399);
        color: white;
        border: none;
        border-radius: 16px;
        width: 56px;
        height: 56px;
        cursor: pointer;
        z-index: 1001;
        transition: all 0.3s ease;
        box-shadow: 0 6px 24px rgba(89, 137, 128, 0.35);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
    }

    .history-toggle:hover {
        background: linear-gradient(135deg, #4a7670, #598980);
        transform: translateY(-50%) scale(1.1);
        box-shadow: 0 8px 32px rgba(89, 137, 128, 0.45);
    }

    .history-toggle:active {
        transform: translateY(-50%) scale(0.95);
    }

    /* Language Selector Styles */
    .language-controls {
        position: absolute;
        top: 12px;
        right: 12px;
        z-index: 1000;
    }

    .language-selector {
        background: rgba(255,255,255,0.95);
        border-radius: 20px;
        box-shadow: 0 4px 16px rgba(89, 137, 128, 0.12);
        padding: 8px 14px;
        display: flex;
        align-items: center;
        gap: 8px;
        border: 1px solid rgba(89, 137, 128, 0.15);
        backdrop-filter: blur(10px);
        transition: all 0.2s;
    }

    .language-selector:hover {
        box-shadow: 0 6px 20px rgba(89, 137, 128, 0.18);
        transform: translateY(-2px);
    }

    .language-selector select {
        border: none;
        background: transparent;
        font-size: 13px;
        font-weight: 600;
        color: #0f172a;
        cursor: pointer;
        outline: none;
        padding: 2px;
    }

    .language-icon {
        font-size: 16px;
        filter: grayscale(0);
    }

    .translate-toggle {
        background: linear-gradient(135deg, #598980, #7ba399);
        color: white;
        border: none;
        border-radius: 16px;
        padding: 8px 14px;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        box-shadow: 0 4px 16px rgba(89, 137, 128, 0.25);
        transition: all 0.2s ease;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2);
    }

    .translate-toggle:hover {
        background: linear-gradient(135deg, #4a7670, #598980);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(89, 137, 128, 0.35);
    }

    .translate-toggle.active {
        background: linear-gradient(135deg, #4ca1af, #598980);
        box-shadow: 0 4px 16px rgba(76, 161, 175, 0.3);
    }

    /* Responsive adjustments - Mobile and Tablet */
    @media (max-width: 1024px) {
        .manas-ai-container {
            height: calc(100vh - 140px);
            margin: 0;
            border-radius: 10px;
        }
        
        .manas-header {
            padding: 15px 10px;
        }
        
        .manas-title {
            font-size: 20px;
        }
        
        .companion-selector {
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .companion-btn {
            padding: 8px 15px;
            font-size: 13px;
        }
        
        .chat-container {
            margin: 15px;
            border-radius: 10px;
        }
        
        .chat-messages {
            padding: 15px;
        }
        
        .message-bubble {
            max-width: 85%;
            font-size: 14px;
        }
        
        .message-avatar {
            width: 35px;
            height: 35px;
            font-size: 16px;
        }
        
        .chat-input-container {
            padding: 15px;
        }
        
        .chat-input {
            font-size: 14px;
            padding: 10px 14px;
        }
        
        .send-btn {
            width: 42px;
            height: 42px;
        }
        
        .language-controls {
            position: static;
            display: flex;
            flex-direction: row;
            justify-content: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .language-selector {
            font-size: 12px;
            padding: 6px 10px;
        }
        
        .translate-toggle {
            font-size: 11px;
            padding: 6px 10px;
        }
    }
    
    /* Small mobile devices */
    @media (max-width: 480px) {
        .manas-ai-container {
            height: calc(100vh - 135px);
            border-radius: 8px;
        }
        
        .manas-header {
            padding: 12px 8px;
        }
        
        .manas-title {
            font-size: 18px;
        }
        
        .companion-selector {
            gap: 8px;
        }
        
        .companion-btn {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        .companion-btn i {
            font-size: 12px;
        }
        
        .chat-container {
            margin: 10px;
            border-radius: 8px;
        }
        
        .chat-messages {
            padding: 10px;
        }
        
        .message {
            margin-bottom: 12px;
        }
        
        .message-bubble {
            max-width: 90%;
            font-size: 13px;
            padding: 10px 14px;
        }
        
        .message-avatar {
            width: 32px;
            height: 32px;
            font-size: 14px;
        }
        
        .chat-input-container {
            padding: 12px;
        }
        
        .chat-input {
            font-size: 13px;
            padding: 10px 12px;
        }
        
        .send-btn {
            width: 40px;
            height: 40px;
            font-size: 16px;
        }
        
        .language-selector {
            font-size: 11px;
            padding: 5px 8px;
        }
        
        .translate-toggle {
            font-size: 10px;
            padding: 5px 8px;
        }
        
        .message-translation {
            font-size: 12px;
            padding: 6px 10px;
        }
    }

    .message-translation {
        margin-top: 8px;
        padding: 8px 12px;
        background: rgba(76, 161, 175, 0.1);
        border-radius: 8px;
        font-size: 13px;
        font-style: italic;
        border-left: 3px solid #4ca1af;
    }

    .translation-badge {
        display: inline-block;
        background: #4ca1af;
        color: white;
        font-size: 10px;
        padding: 2px 6px;
        border-radius: 10px;
        margin-right: 6px;
        font-weight: 500;
    }

    [dir="rtl"] {
        text-align: right;
    }

    [dir="rtl"] .message-bubble {
        text-align: right;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="manas-ai-container">
        <!-- Header -->
        <div class="manas-header">
            <!-- Language Controls -->
            <div class="language-controls">
                <div class="language-selector">
                    <span class="language-icon">üåê</span>
                    <select id="languageSelector" onchange="changeLanguage()">
                        <option value="en">English</option>
                        <option value="hi">‡§π‡§ø‡§Ç‡§¶‡•Ä</option>
                        <option value="bn">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ</option>
                        <option value="te">‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å</option>
                        <option value="mr">‡§Æ‡§∞‡§æ‡§†‡•Ä</option>
                        <option value="ta">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç</option>
                        <option value="gu">‡™ó‡´Å‡™ú‡™∞‡™æ‡™§‡´Ä</option>
                        <option value="kn">‡≤ï‡≤®‡≥ç‡≤®‡≤°</option>
                        <option value="ml">‡¥Æ‡¥≤‡¥Ø‡¥æ‡¥≥‡¥Ç</option>
                        <option value="pa">‡®™‡©∞‡®ú‡®æ‡®¨‡©Ä</option>
                        <option value="ur">ÿßÿ±ÿØŸà</option>
                        <option value="es">Espa√±ol</option>
                        <option value="fr">Fran√ßais</option>
                        <option value="de">Deutsch</option>
                        <option value="ja">Êó•Êú¨Ë™û</option>
                        <option value="ko">ÌïúÍµ≠Ïñ¥</option>
                        <option value="zh">‰∏≠Êñá</option>
                        <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Chat Container -->
        <div class="chat-container">
            <div class="chat-messages" id="chatMessages">
                <!-- Welcome message -->
                <div class="message ai">
                    <div class="message-avatar"></div>
                    <div class="message-bubble">
                        <div>Hello! I'm Arjun, your academic support companion. How can I help you today?</div>
                        <div class="message-timestamp" id="welcomeTime"></div>
                    </div>
                </div>
            </div>

            <!-- Chat Input -->
            <div class="chat-input-container">
                <div class="input-group">
                    <input type="text" class="chat-input" id="messageInput" placeholder="Type your message here..." maxlength="500">
                    <button class="send-btn" id="sendBtn" title="Send">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- History Panel -->
<div class="history-panel" id="historyPanel">
    <div class="history-header">
        <h3 id="chatHistoryTitle">Chat History</h3>
        <div style="display: flex; align-items: center;">
            <button class="new-chat-btn" onclick="startNewChat()">
                <i class="fas fa-plus"></i> <span id="newChatText">New Chat</span>
            </button>
            <button class="history-close-btn" onclick="closeHistory()">√ó</button>
        </div>
    </div>
    <div class="history-content" id="historyContent">
        <!-- History items will be loaded here -->
    </div>
</div>

<!-- History Toggle Button -->
<button class="history-toggle" onclick="toggleHistory()">
    <i class="fas fa-history"></i>
</button>

<!-- Crisis Detection Script -->
<script src="{% static 'js/crisis_detection.js' %}"></script>

<script>
// Global variables
const userFirstName = '{{ user.first_name|default:"User" }}';
const userLastName = '{{ user.last_name|default:"" }}';
const userInitials = (userFirstName.charAt(0) + userLastName.charAt(0)).toUpperCase() || 'U';

let currentCompanion = 'arjun';
let chatHistory = []; // Legacy support
let chatSessions = []; // New session-based storage
let isTyping = false;
let currentSessionId = null;
let currentChatSessionId = null; // For UI session tracking

// Translation variables
let currentLanguage = 'en';
let translationEnabled = false;
let uiTranslations = {};
let supportedLanguages = {};

// Companion configurations
const companions = {
    arjun: {
        name: 'Arjun',
        emoji: 'üß†',
        role: 'Academic Support',
        color: '#28a745',
        welcome: "Hello! I'm Arjun, your academic support companion. How can I help you today?"
    },
    priya: {
        name: 'Priya',
        emoji: 'üíù',
        role: 'Emotional Support',
        color: '#dc3545',
        welcome: "Hi there! I'm Priya, here to provide emotional support. What's on your mind?"
    },
    vikram: {
        name: 'Vikram',
        emoji: '‚ö°',
        role: 'Crisis Support',
        color: '#fd7e14',
        welcome: "I'm Vikram, your crisis support companion. I'm here to help you through difficult times."
    }
};

// Initialize the app
document.addEventListener('DOMContentLoaded', async function() {
    await initializeApp();
});

async function initializeApp() {
    // Set welcome timestamp
    document.getElementById('welcomeTime').textContent = getCurrentTime();
    
    // Load translation system
    await loadSupportedLanguages();
    
    // Load saved language preference
    const savedLanguage = localStorage.getItem('manasLanguage') || 'en';
    if (savedLanguage !== 'en') {
        document.getElementById('languageSelector').value = savedLanguage;
        currentLanguage = savedLanguage;
    }
    
    // Load chat history (legacy)
    loadChatHistory();
    
    // Load chat sessions (new system)
    loadChatSessions();
    
    // Create initial session if none exists OR load current session messages
    if (chatSessions.length === 0) {
        createNewChatSession();
    } else if (currentChatSessionId) {
        // Load the current session messages into the chat view
        const currentSession = chatSessions.find(s => s.id === currentChatSessionId);
        if (currentSession && currentSession.messages.length > 0) {
            loadChatSession(currentChatSessionId);
        }
    }
    
    // Set up event listeners
    setupEventListeners();
    
    // Load saved companion preference
    const savedCompanion = localStorage.getItem('manasCompanion');
    if (savedCompanion && companions[savedCompanion]) {
        await switchCompanion(savedCompanion);
    } else {
        await switchCompanion('arjun'); // Default companion
    }
}

function setupEventListeners() {
    // Companion buttons
    document.querySelectorAll('.companion-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
            const companion = this.dataset.companion;
            await switchCompanion(companion);
        });
    });

    // Message input
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');

    messageInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    sendBtn.addEventListener('click', sendMessage);

    // Auto-resize input and crisis detection
    let crisisDetectionTimeout;
    messageInput.addEventListener('input', function() {
        sendBtn.disabled = this.value.trim() === '';
        
        // Crisis detection with debounce (check after user stops typing)
        if (window.ManasCrisisDetection) {
            clearTimeout(crisisDetectionTimeout);
            crisisDetectionTimeout = setTimeout(() => {
                const text = this.value.trim();
                if (text) {
                    const detection = window.ManasCrisisDetection.detect(text);
                    if (detection && detection.severity === 'severe') {
                        // Show popup immediately for severe cases
                        window.ManasCrisisDetection.showPopup(detection.severity);
                        window.ManasCrisisDetection.sendAlert(text, detection.severity, detection.level);
                    }
                }
            }, 800); // 800ms debounce
        }
    });
}

async function switchCompanion(companionId) {
    if (!companions[companionId]) return;

    currentCompanion = companionId;
    const companion = companions[companionId];

    // Update active button
    document.querySelectorAll('.companion-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.companion === companionId) {
            btn.classList.add('active');
        }
    });

    // Clear chat and show welcome message
    const chatMessages = document.getElementById('chatMessages');
    chatMessages.innerHTML = '';

    // Reset session for new companion
    currentSessionId = null;

    // Start new session and get welcome message
    try {
        console.log(`Starting session with ${companion.name}`);
        const session = await startAISession(companionId);
        
        // Add welcome message from session response
        if (session && session.companion) {
            addAIMessage(companion.welcome, session.companion.name, session.companion.emoji, session.companion.color);
        } else {
            addAIMessage(companion.welcome, companion.name, companion.emoji, companion.color);
        }
    } catch (error) {
        console.error(`Failed to start session with ${companion.name}:`, error);
        // Fallback to static welcome message
        addAIMessage(companion.welcome, companion.name, companion.emoji, companion.color);
    }

    // Save preference
    localStorage.setItem('manasCompanion', companionId);

    console.log(`Switched to ${companion.name}`);
}

function sendMessage() {
    const messageInput = document.getElementById('messageInput');
    const message = messageInput.value.trim();

    if (!message || isTyping) return;

    // Check for crisis keywords before sending
    if (window.ManasCrisisDetection) {
        const detection = window.ManasCrisisDetection.detect(message);
        if (detection) {
            // Show crisis popup
            window.ManasCrisisDetection.showPopup(detection.severity);
            // Send alert to backend
            window.ManasCrisisDetection.sendAlert(message, detection.severity, detection.level);
        }
    }

    // Add user message
    addUserMessage(message);

    // Clear input
    messageInput.value = '';
    document.getElementById('sendBtn').disabled = true;

    // Generate AI response with typing indicator
    generateAIResponse(message);
}

function addUserMessage(text) {
    const chatMessages = document.getElementById('chatMessages');
    const timestamp = getCurrentTime();

    const messageDiv = document.createElement('div');
    messageDiv.className = 'message user';
    messageDiv.innerHTML = `
        <div class="message-avatar">${userInitials}</div>
        <div class="message-bubble">
            <div>${escapeHtml(text)}</div>
            <div class="message-timestamp">${timestamp}</div>
        </div>
    `;

    chatMessages.appendChild(messageDiv);
    scrollToBottom();

    // Add to history (legacy)
    chatHistory.push({
        type: 'user',
        text: text,
        timestamp: timestamp,
        companion: currentCompanion
    });
    
    // Add to session-based history
    addToCurrentSession({
        type: 'user',
        text: text,
        timestamp: timestamp,
        companion: currentCompanion
    });
    
    saveChatHistory();
    saveChatSessions();
}

function addAIMessage(text, name, emoji, color) {
    const chatMessages = document.getElementById('chatMessages');
    const timestamp = getCurrentTime();
    const companion = companions[currentCompanion];

    const messageDiv = document.createElement('div');
    messageDiv.className = 'message ai';
    messageDiv.innerHTML = `
        <div class="message-avatar"></div>
        <div class="message-bubble">
            <div>${escapeHtml(text)}</div>
            <div class="message-timestamp">${timestamp}</div>
        </div>
    `;

    chatMessages.appendChild(messageDiv);
    scrollToBottom();
    
    // Auto-translate if translation is enabled
    if (translationEnabled && currentLanguage !== 'en') {
        const bubble = messageDiv.querySelector('.message-bubble');
        translateMessage(bubble, text);
    }

    // Add to history (legacy)
    chatHistory.push({
        type: 'ai',
        text: text,
        timestamp: timestamp,
        companion: currentCompanion,
        companionName: name || companion.name
    });
    
    // Add to session-based history
    addToCurrentSession({
        type: 'ai',
        text: text,
        timestamp: timestamp,
        companion: currentCompanion,
        companionName: name || companion.name
    });
    
    saveChatHistory();
    saveChatSessions();
    
    // Re-enable send button
    document.getElementById('sendBtn').disabled = false;
}

function showTypingIndicator() {
    if (isTyping) return;
    
    isTyping = true;
    const chatMessages = document.getElementById('chatMessages');
    const companion = companions[currentCompanion];

    const typingDiv = document.createElement('div');
    typingDiv.className = 'message ai typing-message';
    typingDiv.id = 'typingIndicator';
    typingDiv.innerHTML = `
        <div class="message-avatar"></div>
        <div class="typing-indicator">
            <div class="typing-dots">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    `;

    chatMessages.appendChild(typingDiv);
    scrollToBottom();
}

function hideTypingIndicator() {
    isTyping = false;
    const typingIndicator = document.getElementById('typingIndicator');
    if (typingIndicator) {
        typingIndicator.remove();
    }
}

function generateAIResponse(userMessage) {
    const companion = companions[currentCompanion];
    
    // Show typing indicator while waiting for AI response
    showTypingIndicator();
    
    // Add minimum delay to ensure typing animation is visible
    setTimeout(() => {
        // Call actual AI API
        callAIAPI(userMessage, currentCompanion)
            .then(response => {
                hideTypingIndicator();
                addAIMessage(response, companion.name, companion.emoji, companion.color);
            })
            .catch(error => {
                hideTypingIndicator();
                console.error('AI API Error:', error);
                addAIMessage(
                    "I'm sorry, I'm having trouble connecting right now. Please try again in a moment.",
                    companion.name,
                    companion.emoji,
                    companion.color
                );
            });
    }, 800); // Minimum 800ms delay to show typing animation
}

// Start a new AI session
async function startAISession(companion) {
    try {
        console.log(`Starting new AI session with ${companion}`);
        const response = await fetch('/api/v1/chat/api/session/start/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrf-token]').content
            },
            body: JSON.stringify({
                companion: companion
            })
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        
        if (data.success && data.session_id) {
            currentSessionId = data.session_id;
            console.log(`Session started successfully with ID: ${currentSessionId}`);
            return data;
        }
        
        throw new Error('Failed to start session');
    } catch (error) {
        console.error('Failed to start AI session:', error);
        throw error;
    }
}

// Send message to existing AI session
async function sendMessageToSession(message) {
    try {
        if (!currentSessionId) {
            // Start a new session if none exists
            await startAISession(currentCompanion);
        }

        console.log(`Sending message to session ${currentSessionId}: ${message.substring(0, 50)}...`);
        
        const response = await fetch('/api/v1/chat/api/message/send/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrf-token]').content
            },
            body: JSON.stringify({
                message: message,
                session_id: currentSessionId,
                companion: currentCompanion || 'arjun'
            })
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        
        if (data.success && data.ai_response) {
            console.log('AI response received successfully');
            return data.ai_response.message;
        }
        
        throw new Error('Invalid response format');
    } catch (error) {
        console.error('API call failed:', error);
        throw error;
    }
}

// AI API call function (updated to use session-based approach)
async function callAIAPI(message, companion) {
    try {
        // If companion changed, start a new session
        if (companion !== currentCompanion) {
            currentSessionId = null; // Reset session
        }
        
        return await sendMessageToSession(message);
    } catch (error) {
        console.error('AI API call failed:', error);
        
        // Fallback responses
        const fallbackResponses = {
            arjun: [
                "I understand you need academic support. Can you tell me more about what you're working on?",
                "That's an interesting question. Let me help you break it down step by step.",
                "I'm here to help with your studies. What specific area are you finding challenging?"
            ],
            priya: [
                "I hear you, and I want you to know that your feelings are valid. Tell me more about what's on your mind.",
                "It sounds like you're going through something difficult. I'm here to listen and support you.",
                "Thank you for sharing with me. How are you feeling right now about this situation?"
            ],
            vikram: [
                "I'm here for you right now. Your safety and well-being are my priority. How can I help?",
                "It takes courage to reach out. I want you to know that you're not alone in this.",
                "I'm concerned about what you're going through. Can you tell me more about how you're feeling?"
            ]
        };

        const responses = fallbackResponses[companion] || fallbackResponses.arjun;
        return responses[Math.floor(Math.random() * responses.length)];
    }
}

// History functions
function toggleHistory() {
    const historyPanel = document.getElementById('historyPanel');
    historyPanel.classList.toggle('open');
    
    if (historyPanel.classList.contains('open')) {
        loadHistoryPanel();
    }
}

function closeHistory() {
    document.getElementById('historyPanel').classList.remove('open');
}

function loadHistoryPanel() {
    const historyContent = document.getElementById('historyContent');
    
    if (chatSessions.length === 0) {
        historyContent.innerHTML = `
            <div class="history-empty">
                <div class="history-empty-icon">üí¨</div>
                <p>No chat sessions yet.</p>
                <p style="font-size: 12px; margin-top: 5px;">Start a conversation with your MANAS companion!</p>
            </div>
        `;
        return;
    }

    // Sort sessions by last message time (newest first)
    const sortedSessions = [...chatSessions].sort((a, b) => {
        const aTime = new Date(a.lastMessageTime || a.startTime);
        const bTime = new Date(b.lastMessageTime || b.startTime);
        return bTime - aTime;
    });

    let historyHTML = '';
    sortedSessions.forEach(session => {
        const companion = companions[session.companion];
        const messageCount = session.messages.length;
        const lastMessage = session.messages[messageCount - 1];
        const sessionTitle = getSessionTitle(session);
        const isCurrentSession = session.id === currentChatSessionId;
        
        // Format last message time
        let lastMessageTime = '';
        if (lastMessage && lastMessage.timestamp) {
            lastMessageTime = `‚Ä¢ Last: ${lastMessage.timestamp}`;
        } else if (session.lastMessageTime) {
            lastMessageTime = `‚Ä¢ Last: ${formatSessionTime(session.lastMessageTime)}`;
        }
        
        historyHTML += `
            <div class="history-section session-item ${isCurrentSession ? 'current-session' : ''}" data-session-id="${session.id}">
                <div class="session-header">
                    <div class="session-info" onclick="loadChatSession('${session.id}')">
                        <div class="session-title">
                            <span class="session-companion">${companion.emoji} ${companion.name}</span>
                            <span class="session-time">${formatSessionTime(session.startTime)}</span>
                        </div>
                        <div class="session-preview">
                            ${escapeHtml(sessionTitle)}
                        </div>
                        <div class="session-meta">
                            <span>${messageCount} messages</span>
                            ${lastMessageTime}
                        </div>
                    </div>
                    <button class="delete-chat-btn" onclick="deleteChatSession('${session.id}')" title="Delete this conversation">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
    });

    historyContent.innerHTML = historyHTML;
}

// Utility functions
function getCurrentTime() {
    return new Date().toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
}

function scrollToBottom() {
    const chatMessages = document.getElementById('chatMessages');
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

async function changeLanguage() {
    const selector = document.getElementById('languageSelector');
    const newLanguage = selector.value;
    
    if (newLanguage === currentLanguage) return;
    
    currentLanguage = newLanguage;
    localStorage.setItem('manasLanguage', currentLanguage);
    
    // Load UI translations
    await loadUITranslations(currentLanguage);
    
    // Update welcome message if needed
    if (currentLanguage !== 'en') {
        await updateWelcomeMessage();
    }
    
    // Translate existing messages if translation is enabled
    if (translationEnabled) {
        await translateAllMessages();
    }
}

async function toggleTranslation() {
    translationEnabled = !translationEnabled;
    const toggleBtn = document.getElementById('translateToggle');
    const toggleText = document.getElementById('translateToggleText');
    
    if (translationEnabled) {
        toggleBtn.classList.add('active');
        toggleText.textContent = uiTranslations.original_language || 'Original';
        await translateAllMessages();
    } else {
        toggleBtn.classList.remove('active');
        toggleText.textContent = uiTranslations.translate_messages || 'Translate';
        removeAllTranslations();
    }
}

async function translateAllMessages() {
    if (!translationEnabled || currentLanguage === 'en') return;
    
    const messages = document.querySelectorAll('.message-bubble > div:first-child');
    for (const messageDiv of messages) {
        const originalText = messageDiv.textContent;
        if (originalText && !messageDiv.querySelector('.message-translation')) {
            const translatedText = await translateText(originalText, currentLanguage);
            if (translatedText !== originalText) {
                const translationDiv = document.createElement('div');
                translationDiv.className = 'message-translation';
                translationDiv.innerHTML = `<span class="translation-badge">${supportedLanguages[currentLanguage] || currentLanguage}</span>${escapeHtml(translatedText)}`;
                messageDiv.parentNode.insertBefore(translationDiv, messageDiv.nextSibling);
            }
        }
    }
}

function removeAllTranslations() {
    const translations = document.querySelectorAll('.message-translation');
    translations.forEach(translation => translation.remove());
}

async function updateWelcomeMessage() {
    const welcomeMessage = document.querySelector('.message.ai .message-bubble > div:first-child');
    if (welcomeMessage) {
        const translatedWelcome = await getTranslatedWelcomeMessage(currentCompanion, currentLanguage);
        welcomeMessage.textContent = translatedWelcome;
    }
}

// Session management functions
function createNewChatSession() {
    const sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    const newSession = {
        id: sessionId,
        companion: currentCompanion,
        startTime: new Date().toISOString(),
        lastMessageTime: null,
        messages: []
    };
    
    chatSessions.push(newSession);
    currentChatSessionId = sessionId;
    saveChatSessions();
    
    return newSession;
}

function addToCurrentSession(message) {
    if (!currentChatSessionId) {
        createNewChatSession();
    }
    
    const session = chatSessions.find(s => s.id === currentChatSessionId);
    if (session) {
        session.messages.push(message);
        session.lastMessageTime = new Date().toISOString();
    }
}

function getSessionTitle(session) {
    if (session.messages.length === 0) return 'New conversation';
    
    // Find first user message
    const firstUserMessage = session.messages.find(m => m.type === 'user');
    if (firstUserMessage) {
        return firstUserMessage.text.length > 50 
            ? firstUserMessage.text.substring(0, 50) + '...' 
            : firstUserMessage.text;
    }
    
    return 'Conversation with ' + companions[session.companion].name;
}

function formatSessionTime(isoString) {
    const date = new Date(isoString);
    const now = new Date();
    const diffHours = (now - date) / (1000 * 60 * 60);
    
    if (diffHours < 1) {
        return 'Just now';
    } else if (diffHours < 24) {
        return Math.floor(diffHours) + 'h ago';
    } else if (diffHours < 168) { // 7 days
        return Math.floor(diffHours / 24) + 'd ago';
    } else {
        return date.toLocaleDateString([], {month: 'short', day: 'numeric'});
    }
}

function loadChatSession(sessionId) {
    const session = chatSessions.find(s => s.id === sessionId);
    if (!session) return;
    
    // Switch to session's companion if different
    if (session.companion !== currentCompanion) {
        switchCompanion(session.companion);
    }
    
    // Clear current chat
    const chatMessages = document.getElementById('chatMessages');
    const companion = companions[session.companion];
    
    // Add welcome message
    let chatHTML = `
        <div class="message ai">
            <div class="message-avatar"></div>
            <div class="message-bubble">
                <div>${companion.welcome}</div>
                <div class="message-timestamp">${formatSessionTime(session.startTime)}</div>
            </div>
        </div>
    `;
    
    // Add session messages
    session.messages.forEach(msg => {
        if (msg.type === 'user') {
            chatHTML += `
                <div class="message user">
                    <div class="message-avatar">${userInitials}</div>
                    <div class="message-bubble">
                        <div>${escapeHtml(msg.text)}</div>
                        <div class="message-timestamp">${msg.timestamp}</div>
                    </div>
                </div>
            `;
        } else {
            chatHTML += `
                <div class="message ai">
                    <div class="message-avatar"></div>
                    <div class="message-bubble">
                        <div>${escapeHtml(msg.text)}</div>
                        <div class="message-timestamp">${msg.timestamp}</div>
                    </div>
                </div>
            `;
        }
    });
    
    chatMessages.innerHTML = chatHTML;
    scrollToBottom();
    
    // Set current session
    currentChatSessionId = sessionId;
    
    // Close history panel
    closeHistory();
}

function saveChatSessions() {
    try {
        localStorage.setItem('manasChatSessions', JSON.stringify(chatSessions));
    } catch (error) {
        console.error('Failed to save chat sessions:', error);
    }
}

function loadChatSessions() {
    try {
        const saved = localStorage.getItem('manasChatSessions');
        if (saved) {
            chatSessions = JSON.parse(saved);
            // Set current session to the most recent one
            if (chatSessions.length > 0) {
                const mostRecent = chatSessions.sort((a, b) => {
                    const aTime = new Date(a.lastMessageTime || a.startTime);
                    const bTime = new Date(b.lastMessageTime || b.startTime);
                    return bTime - aTime;
                })[0];
                currentChatSessionId = mostRecent.id;
            }
        }
    } catch (error) {
        console.error('Failed to load chat sessions:', error);
        chatSessions = [];
    }
}

// New Chat functionality
function startNewChat() {
    // Clear current chat
    const chatMessages = document.getElementById('chatMessages');
    
    // Keep only the welcome message
    const companion = companions[currentCompanion];
    chatMessages.innerHTML = `
        <div class="message ai">
            <div class="message-avatar"></div>
            <div class="message-bubble">
                <div>${companion.welcome}</div>
                <div class="message-timestamp" id="welcomeTime">${getCurrentTime()}</div>
            </div>
        </div>
    `;
    
    // Create new session
    createNewChatSession();
    
    // Reset API session
    currentSessionId = null;
    
    // Close history panel
    closeHistory();
}

// Delete specific chat session
function deleteChatSession(sessionId) {
    const session = chatSessions.find(s => s.id === sessionId);
    if (!session) return;
    
    const companion = companions[session.companion];
    const sessionTitle = getSessionTitle(session);
    
    if (confirm(`Are you sure you want to delete this conversation?\n\n"${sessionTitle}"\n\nThis action cannot be undone.`)) {
        // Remove session from array
        chatSessions = chatSessions.filter(s => s.id !== sessionId);
        
        // Save updated sessions
        saveChatSessions();
        
        // If we deleted the current session, start a new one
        if (sessionId === currentChatSessionId) {
            startNewChat();
            return;
        }
        
        // Reload history panel to reflect changes
        loadHistoryPanel();
        
        console.log(`Deleted chat session: ${sessionTitle}`);
    }
}

function saveChatHistory() {
    try {
        localStorage.setItem('manasChatHistory', JSON.stringify(chatHistory));
    } catch (error) {
        console.error('Failed to save chat history:', error);
    }
}

function loadChatHistory() {
    try {
        const saved = localStorage.getItem('manasChatHistory');
        if (saved) {
            chatHistory = JSON.parse(saved);
        }
    } catch (error) {
        console.error('Failed to load chat history:', error);
        chatHistory = [];
    }
}

// Clear history function
function clearHistory() {
    if (confirm('Are you sure you want to clear all chat history?')) {
        chatHistory = [];
        localStorage.removeItem('manasChatHistory');
        document.getElementById('chatMessages').innerHTML = '';
        
        // Show welcome message for current companion
        const companion = companions[currentCompanion];
        addAIMessage(companion.welcome, companion.name, companion.emoji, companion.color);
        
        closeHistory();
    }
}

// Translation Functions
async function loadSupportedLanguages() {
    try {
        const response = await fetch('/api/v1/chat/api/translate/languages/', {
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        const data = await response.json();
        if (data.success) {
            supportedLanguages = data.languages;
            console.log('Loaded supported languages:', Object.keys(supportedLanguages).length);
        }
    } catch (error) {
        console.error('Failed to load supported languages:', error);
    }
}

async function changeLanguage() {
    const selector = document.getElementById('languageSelector');
    currentLanguage = selector.value;
    localStorage.setItem('manasLanguage', currentLanguage);
    
    console.log('Language changed to:', currentLanguage);
    
    // If translation is enabled, re-translate all messages
    if (translationEnabled) {
        await translateAllMessages();
    }
}

async function toggleTranslation() {
    translationEnabled = !translationEnabled;
    const toggleBtn = document.getElementById('translateToggle');
    const toggleText = document.getElementById('translateToggleText');
    
    if (translationEnabled) {
        toggleBtn.classList.add('active');
        toggleText.textContent = 'Translation On';
        await translateAllMessages();
    } else {
        toggleBtn.classList.remove('active');
        toggleText.textContent = 'Translate';
        removeAllTranslations();
    }
}

async function translateAllMessages() {
    const messages = document.querySelectorAll('.message-bubble');
    
    for (const bubble of messages) {
        // Skip if already has translation
        if (bubble.querySelector('.message-translation')) {
            continue;
        }
        
        const textDiv = bubble.querySelector('div:first-child');
        if (!textDiv) continue;
        
        const originalText = textDiv.textContent.trim();
        if (!originalText) continue;
        
        await translateMessage(bubble, originalText);
    }
}

async function translateMessage(bubbleElement, originalText) {
    if (currentLanguage === 'en') {
        return; // No need to translate to English
    }
    
    try {
        const response = await fetch('/api/v1/chat/api/translate/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                text: originalText,
                target_language: currentLanguage,
                source_language: 'en'
            })
        });
        
        const data = await response.json();
        
        console.log('Translation response:', data); // Debug log
        
        if (data.success && data.translated_text) {
            // Check if translation div already exists
            let translationDiv = bubbleElement.querySelector('.message-translation');
            
            if (!translationDiv) {
                translationDiv = document.createElement('div');
                translationDiv.className = 'message-translation';
                bubbleElement.appendChild(translationDiv);
            }
            
            const languageName = supportedLanguages[currentLanguage] || currentLanguage.toUpperCase();
            translationDiv.innerHTML = `
                <span class="translation-badge">${languageName}</span>
                ${escapeHtml(data.translated_text)}
            `;
            
            // Set text direction for RTL languages
            if (['ar', 'ur', 'he', 'fa'].includes(currentLanguage)) {
                translationDiv.setAttribute('dir', 'rtl');
            }
        } else {
            console.error('Translation failed:', data.error || 'No translated text');
        }
    } catch (error) {
        console.error('Translation failed:', error);
    }
}

function removeAllTranslations() {
    const translations = document.querySelectorAll('.message-translation');
    translations.forEach(translation => translation.remove());
}

function addTranslateButton(bubble, originalText) {
    // Check if button already exists
    if (bubble.querySelector('.translate-btn')) {
        return;
    }
    
    const translateBtn = document.createElement('button');
    translateBtn.className = 'translate-btn';
    translateBtn.innerHTML = '<i class="fas fa-language"></i> Translate';
    translateBtn.onclick = () => translateMessage(bubble, originalText);
    
    bubble.appendChild(translateBtn);
}

console.log('MANAS AI initialized successfully');
</script>
{% endblock %}
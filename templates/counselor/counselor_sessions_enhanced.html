{% extends 'counselor/base_counselor_admin.html' %}

{% block title %}Session Management - MANAS{% endblock %}

{% block content %}
<!-- Session Management Header -->
<div style="background: linear-gradient(135deg, rgba(142, 224, 254, 0.1) 0%, rgba(255, 233, 180, 0.1) 100%); border: 1px solid rgba(142, 224, 254, 0.2); border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 2rem;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h3 style="font-size: 1.125rem; font-weight: 700; color: #0284c7; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                üìÖ Session Management Center
            </h3>
            <p style="color: #0369a1; font-size: 0.875rem;">Manage {{ stats.today_sessions|default:"8" }} sessions today ‚Ä¢ {{ counselor_requests|default:"3" }} counselor requests pending</p>
        </div>
        <div style="display: flex; gap: 1rem;">
            <button id="viewRequestsBtn" style="background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%); color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; border: none; font-weight: 600; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; gap: 0.5rem;" 
                    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(245, 158, 11, 0.3)'"
                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'"
                    onclick="showCounselorRequests()">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"/>
                </svg>
                Counselor Requests (<span id="requestCount">3</span>)
            </button>
            <button style="background: linear-gradient(135deg, #8ee0fe 0%, #ffe9b4 100%); color: #0369a1; padding: 0.75rem 1.5rem; border-radius: 0.5rem; border: none; font-weight: 600; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; gap: 0.5rem;" 
                    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(142, 224, 254, 0.3)'"
                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'"
                    onclick="scheduleNewSession()">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z"/>
                </svg>
                Schedule Session
            </button>
        </div>
    </div>
</div>

<!-- Counselor Requests Modal -->
<div id="counselorRequestsModal" class="counselor-modal" style="display: none;">
    <div class="counselor-modal-content" style="max-width: 800px;">
        <div class="counselor-modal-header">
            <h3>üë• Students Requesting You as Counselor</h3>
            <button class="counselor-modal-close" onclick="closeCounselorRequests()">&times;</button>
        </div>
        <div id="counselorRequestsList" class="counselor-modal-body">
            <!-- Requests will be populated here -->
        </div>
    </div>
</div>

<!-- Session Statistics Overview -->
<div class="counselor-stats-grid">
    <div class="counselor-stat-card">
        <div class="counselor-stat-icon counselor-stat-icon-sessions">
            <svg width="24" height="24" fill="currentColor" viewBox="0 0 20 20">
                <path d="M10 2L3 7v11a2 2 0 002 2h4v-6h2v6h4a2 2 0 002-2V7l-7-5z"/>
            </svg>
        </div>
        <div class="counselor-stat-number">{{ stats.today_sessions|default:"8" }}</div>
        <div class="counselor-stat-label">Today's Sessions</div>
        <div class="counselor-stat-trend counselor-trend-up">+2 more than yesterday</div>
    </div>
    
    <div class="counselor-stat-card">
        <div class="counselor-stat-icon counselor-stat-icon-students">
            <svg width="24" height="24" fill="currentColor" viewBox="0 0 20 20">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
            </svg>
        </div>
        <div class="counselor-stat-number">{{ stats.upcoming_sessions|default:"12" }}</div>
        <div class="counselor-stat-label">Upcoming Sessions</div>
        <div class="counselor-stat-trend counselor-trend-up">Next 7 days</div>
    </div>
    
    <div class="counselor-stat-card">
        <div class="counselor-stat-icon counselor-stat-icon-rating">
            <svg width="24" height="24" fill="currentColor" viewBox="0 0 20 20">
                <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"/>
            </svg>
        </div>
        <div class="counselor-stat-number">{{ stats.calls_today|default:"6" }}</div>
        <div class="counselor-stat-label">Calls Today</div>
        <div class="counselor-stat-trend counselor-trend-up">Voice & Video</div>
    </div>
    
    <div class="counselor-stat-card">
        <div class="counselor-stat-icon counselor-stat-icon-crisis">
            <svg width="24" height="24" fill="currentColor" viewBox="0 0 20 20">
                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
                <path fillRule="evenodd" d="M4 5a2 2 0 012-2v1a2 2 0 00-2 2v6a2 2 0 002 2h10a2 2 0 002-2V6a2 2 0 00-2-2V3a2 2 0 012 2v6a4 4 0 01-4 4H6a4 4 0 01-4-4V5z" clipRule="evenodd"/>
            </svg>
        </div>
        <div class="counselor-stat-number">{{ stats.pending_notes|default:"3" }}</div>
        <div class="counselor-stat-label">Pending Notes</div>
        <div class="counselor-stat-trend counselor-trend-neutral">To be completed</div>
    </div>
</div>

<!-- Quick Actions & Filters -->
<div class="counselor-form-section">
    <div class="counselor-form-header">
        <h3>üìÖ Session Management</h3>
        <div class="counselor-header-actions">
            <button class="counselor-btn counselor-btn-primary" onclick="toggleFilters()">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                    <path fillRule="evenodd" d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.293.707L12 11.414V15a1 1 0 01-.293.707l-2 2A1 1 0 018 17v-5.586L3.293 6.707A1 1 0 013 6V3z" clipRule="evenodd"/>
                </svg>
                Filters
            </button>
            <button class="counselor-btn counselor-btn-success" onclick="scheduleNewSession()">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                    <path fillRule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clipRule="evenodd"/>
                </svg>
                New Session
            </button>
        </div>
    </div>
    
    <!-- Filter Section -->
    <div class="counselor-filter-section" id="filter-section" style="display: none;">
        <div class="counselor-filter-grid">
            <button class="counselor-filter-btn active" data-filter="all">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                    <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM4.332 8.027a6.012 6.012 0 011.912-2.706C6.512 5.73 6.974 6 7.5 6A1.5 1.5 0 019 7.5V8a2 2 0 004 0 2 2 0 011.523-1.943A5.977 5.977 0 0116 10c0 .34-.028.675-.083 1H15a2 2 0 00-2 2v2.197A5.973 5.973 0 0110 16v-2a2 2 0 00-2-2 2 2 0 01-2-2 2 2 0 00-1.668-1.973z" clipRule="evenodd"/>
                </svg>
                All Sessions
            </button>
            <button class="counselor-filter-btn" data-filter="scheduled">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                    <path fillRule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clipRule="evenodd"/>
                </svg>
                Scheduled
            </button>
            <button class="counselor-filter-btn" data-filter="in_progress">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                    <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clipRule="evenodd"/>
                </svg>
                In Progress
            </button>
            <button class="counselor-filter-btn" data-filter="completed">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                    <path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd"/>
                </svg>
                Completed
            </button>
        </div>
    </div>
</div>

<!-- Sessions List -->
<div class="counselor-card-grid">
    {% for session in sessions %}
    <div class="counselor-session-card" data-status="{{ session.status }}">
        <div class="counselor-session-header">
            <div class="counselor-session-avatar">
                {{ session.student.first_name.0 }}{{ session.student.last_name.0 }}
            </div>
            <div class="counselor-session-info">
                <h4>{{ session.student.get_full_name|default:"John Smith" }}</h4>
                <p>{{ session.student.email|default:"john.smith@student.edu" }}</p>
                {% if session.preferred_counselor and session.preferred_counselor == user %}
                    <span style="background: rgba(245, 158, 11, 0.1); color: #d97706; padding: 0.25rem 0.5rem; border-radius: 0.375rem; font-size: 0.75rem; font-weight: 600;">
                        üéØ Specifically Requested You
                    </span>
                {% endif %}
            </div>
            <span class="counselor-badge counselor-badge-{{ session.status|default:'scheduled' }}">
                {{ session.status|default:'Scheduled'|capfirst }}
            </span>
        </div>
        
        <div class="counselor-session-details">
            <div class="counselor-detail-item">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                    <path fillRule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clipRule="evenodd"/>
                </svg>
                <span>{{ session.scheduled_date|default:"Mar 25, 2025"|date:"M d, Y" }}</span>
            </div>
            <div class="counselor-detail-item">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                    <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clipRule="evenodd"/>
                </svg>
                <span>{{ session.scheduled_time|default:"10:30 AM"|time:"g:i A" }}</span>
            </div>
            <div class="counselor-detail-item">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
                    <path fillRule="evenodd" d="M4 5a2 2 0 012-2v1a2 2 0 00-2 2v6a2 2 0 002 2h10a2 2 0 002-2V6a2 2 0 00-2-2V3a2 2 0 012 2v6a4 4 0 01-4 4H6a4 4 0 01-4-4V5z" clipRule="evenodd"/>
                </svg>
                <span>{{ session.duration_minutes|default:"60" }} minutes</span>
            </div>
            <div class="counselor-detail-item">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                    {% if session.meeting_type == 'video_call' %}
                        <path d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14.553 7.106A1 1 0 0014 8v4a1 1 0 00.553.894l2 1A1 1 0 0018 13V7a1 1 0 00-1.447-.894l-2 1z"/>
                    {% elif session.meeting_type == 'phone_call' or session.meeting_type == 'voice_call' %}
                        <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"/>
                    {% else %}
                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                    {% endif %}
                </svg>
                <span>{{ session.get_meeting_type_display|default:"Video Call" }}</span>
            </div>
        </div>

        {% if session.preference_reason %}
        <div class="counselor-session-notes">
            <h6>Why Student Requested You:</h6>
            <p>{{ session.preference_reason|truncatechars:120 }}</p>
        </div>
        {% endif %}

        {% if session.notes %}
        <div class="counselor-session-notes">
            <h6>Session Notes</h6>
            <p>{{ session.notes|truncatechars:120|default:"Student shows good progress in managing anxiety. Working on coping strategies and stress management techniques." }}</p>
        </div>
        {% endif %}

        <div class="counselor-session-actions">
            {% if session.status == 'confirmed' or session.status == 'scheduled' %}
                {% if session.meeting_type == 'video_call' or session.meeting_type == 'voice_call' or session.meeting_type == 'phone_call' %}
                    <button class="counselor-btn counselor-btn-primary counselor-btn-sm" onclick="initiateCall('{{ session.id }}', '{{ session.meeting_type }}')">
                        <svg width="14" height="14" fill="currentColor" viewBox="0 0 20 20">
                            {% if session.meeting_type == 'video_call' %}
                                <path d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14.553 7.106A1 1 0 0014 8v4a1 1 0 00.553.894l2 1A1 1 0 0018 13V7a1 1 0 00-1.447-.894l-2 1z"/>
                            {% else %}
                                <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"/>
                            {% endif %}
                        </svg>
                        Start {{ session.get_meeting_type_display }}
                    </button>
                {% else %}
                    <button class="counselor-btn counselor-btn-primary counselor-btn-sm" onclick="startSession('{{ session.id }}')">
                        <svg width="14" height="14" fill="currentColor" viewBox="0 0 20 20">
                            <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clipRule="evenodd"/>
                        </svg>
                        Start Session
                    </button>
                {% endif %}
                <button class="counselor-btn counselor-btn-warning counselor-btn-sm" onclick="rescheduleSession('{{ session.id }}')">
                    <svg width="14" height="14" fill="currentColor" viewBox="0 0 20 20">
                        <path fillRule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clipRule="evenodd"/>
                    </svg>
                    Reschedule
                </button>
            {% elif session.status == 'in_progress' %}
                <button class="counselor-btn counselor-btn-danger counselor-btn-sm" onclick="endCall('{{ session.id }}')">
                    <svg width="14" height="14" fill="currentColor" viewBox="0 0 20 20">
                        <path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM8 8a1 1 0 000 2h4a1 1 0 100-2H8z" clipRule="evenodd"/>
                    </svg>
                    End Session
                </button>
                <button class="counselor-btn counselor-btn-secondary counselor-btn-sm" onclick="addSessionNote('{{ session.id }}')">
                    <svg width="14" height="14" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.828-2.828z"/>
                    </svg>
                    Add Note
                </button>
            {% elif session.status == 'completed' %}
                <button class="counselor-btn counselor-btn-success counselor-btn-sm" onclick="viewNotes('{{ session.id }}')">
                    <svg width="14" height="14" fill="currentColor" viewBox="0 0 20 20">
                        <path fillRule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clipRule="evenodd"/>
                    </svg>
                    View Notes
                </button>
                <button class="counselor-btn counselor-btn-secondary counselor-btn-sm" onclick="editNotes('{{ session.id }}')">
                    <svg width="14" height="14" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.828-2.828z"/>
                    </svg>
                    Edit Notes
                </button>
            {% endif %}
            <button class="counselor-btn counselor-btn-outline counselor-btn-sm" onclick="viewDetails('{{ session.id }}')">
                <svg width="14" height="14" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/>
                    <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM4.332 8.027a6.012 6.012 0 011.912-2.706C6.512 5.73 6.974 6 7.5 6A1.5 1.5 0 019 7.5V8a2 2 0 004 0 2 2 0 011.523-1.943A5.977 5.977 0 0116 10c0 .34-.028.675-.083 1H15a2 2 0 00-2 2v2.197A5.973 5.973 0 0110 16v-2a2 2 0 00-2-2 2 2 0 01-2-2 2 2 0 00-1.668-1.973z" clipRule="evenodd"/>
                </svg>
                Details
            </button>
        </div>
    </div>
    {% empty %}
    <div class="counselor-empty-state">
        <div class="counselor-empty-icon">
            <svg width="64" height="64" fill="currentColor" viewBox="0 0 20 20">
                <path fillRule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clipRule="evenodd"/>
            </svg>
        </div>
        <h4>No Sessions Found</h4>
        <p>You haven't scheduled any sessions yet. Start by creating your first session.</p>
        <button class="counselor-btn counselor-btn-primary" onclick="scheduleNewSession()">
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                <path fillRule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clipRule="evenodd"/>
            </svg>
            Schedule First Session
        </button>
    </div>
    {% endfor %}
</div>

<!-- Call Progress Modal -->
<div id="callProgressModal" class="counselor-modal" style="display: none;">
    <div class="counselor-modal-content">
        <div class="counselor-modal-header">
            <h3 id="callTitle">üìû Call in Progress</h3>
        </div>
        <div class="counselor-modal-body" style="text-align: center; padding: 2rem;">
            <div id="callInfo" style="margin-bottom: 2rem;">
                <p id="callStatus">Connecting to student...</p>
                <div style="margin: 1rem 0;">
                    <span id="callTimer" style="font-size: 1.5rem; font-weight: 600; color: #059669;">00:00</span>
                </div>
                <p id="callDetails" style="color: #6b7280; font-size: 0.875rem;"></p>
            </div>
            <div style="display: flex; gap: 1rem; justify-content: center;">
                <button id="muteBtn" class="counselor-btn counselor-btn-secondary" onclick="toggleMute()">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                        <path fillRule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.617.815L4.975 14H2a1 1 0 01-1-1V7a1 1 0 011-1h2.975l3.408-2.815a1 1 0 01.617-.264z" clipRule="evenodd"/>
                    </svg>
                    Mute
                </button>
                <button id="endCallBtn" class="counselor-btn counselor-btn-danger" onclick="endCallSession()">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                        <path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM8 8a1 1 0 000 2h4a1 1 0 100-2H8z" clipRule="evenodd"/>
                    </svg>
                    End Call
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.counselor-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
}

.counselor-modal-content {
    background: white;
    border-radius: 0.75rem;
    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
    max-width: 600px;
    width: 90%;
    max-height: 80vh;
    overflow: auto;
}

.counselor-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem;
    border-bottom: 1px solid #e5e7eb;
}

.counselor-modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0.5rem;
    color: #6b7280;
}

.counselor-modal-close:hover {
    color: #374151;
}

.counselor-modal-body {
    padding: 1.5rem;
}

.counselor-request-card {
    background: #f8fafc;
    border: 1px solid #e5e7eb;
    border-radius: 0.5rem;
    padding: 1rem;
    margin-bottom: 1rem;
}

.counselor-request-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 0.75rem;
}

.counselor-request-actions {
    display: flex;
    gap: 0.5rem;
}

.counselor-btn-xs {
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
    border-radius: 0.25rem;
}

.call-progress-indicator {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}
</style>

<script>
// Global variables for call management
let currentCallId = null;
let callTimer = null;
let callStartTime = null;
let isMuted = false;

// Load counselor requests on page load
document.addEventListener('DOMContentLoaded', function() {
    loadCounselorRequests();
    
    // Filter functionality
    const filterBtns = document.querySelectorAll('.counselor-filter-btn');
    filterBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            filterBtns.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            filterSessions(this.getAttribute('data-filter'));
        });
    });
});

function toggleFilters() {
    const filterSection = document.getElementById('filter-section');
    filterSection.style.display = filterSection.style.display === 'none' ? 'block' : 'none';
}

function scheduleNewSession() {
    showNotification('Schedule Session feature coming soon!', 'info');
}

async function loadCounselorRequests() {
    try {
        const response = await fetch('/api/counselor/requests/');
        const data = await response.json();
        
        if (data.status === 'success') {
            document.getElementById('requestCount').textContent = data.requests.length;
            displayCounselorRequests(data.requests);
        }
    } catch (error) {
        console.error('Error loading counselor requests:', error);
    }
}

function displayCounselorRequests(requests) {
    const container = document.getElementById('counselorRequestsList');
    
    if (requests.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 2rem; color: #6b7280;">
                <svg width="48" height="48" fill="currentColor" viewBox="0 0 20 20" style="margin-bottom: 1rem;">
                    <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"/>
                </svg>
                <h4>No Student Requests</h4>
                <p>No students have specifically requested you as their counselor at this time.</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = requests.map(request => `
        <div class="counselor-request-card">
            <div class="counselor-request-header">
                <div>
                    <h5 style="font-weight: 600; color: #1f2937; margin-bottom: 0.25rem;">${request.student_name}</h5>
                    <p style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.5rem;">${request.student_email}</p>
                    <div style="display: flex; gap: 1rem; font-size: 0.875rem; color: #6b7280;">
                        <span>üìÖ ${request.scheduled_date}</span>
                        <span>üïê ${request.scheduled_time}</span>
                        <span>üìû ${request.meeting_type}</span>
                    </div>
                </div>
                <span class="counselor-badge counselor-badge-${request.status}">${request.status}</span>
            </div>
            
            <div style="margin-bottom: 1rem;">
                <h6 style="font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Reason for Session:</h6>
                <p style="font-size: 0.875rem; color: #6b7280;">${request.reason}</p>
            </div>
            
            ${request.preference_reason ? `
            <div style="margin-bottom: 1rem; background: rgba(245, 158, 11, 0.1); padding: 0.75rem; border-radius: 0.375rem;">
                <h6 style="font-weight: 600; color: #d97706; margin-bottom: 0.5rem;">Why they chose you:</h6>
                <p style="font-size: 0.875rem; color: #92400e;">${request.preference_reason}</p>
            </div>
            ` : ''}
            
            <div class="counselor-request-actions">
                <button class="counselor-btn counselor-btn-success counselor-btn-xs" onclick="handleRequest('${request.id}', 'accept')">
                    ‚úì Accept
                </button>
                <button class="counselor-btn counselor-btn-warning counselor-btn-xs" onclick="suggestAlternative('${request.id}')">
                    üîÑ Suggest Alternative
                </button>
                <button class="counselor-btn counselor-btn-danger counselor-btn-xs" onclick="declineRequest('${request.id}')">
                    ‚úó Decline
                </button>
            </div>
        </div>
    `).join('');
}

function showCounselorRequests() {
    document.getElementById('counselorRequestsModal').style.display = 'flex';
}

function closeCounselorRequests() {
    document.getElementById('counselorRequestsModal').style.display = 'none';
}

async function handleRequest(appointmentId, action, additionalData = {}) {
    try {
        const response = await fetch('/api/counselor/requests/handle/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                appointment_id: appointmentId,
                action: action,
                ...additionalData
            })
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            showNotification(data.message, 'success');
            loadCounselorRequests(); // Refresh the list
            closeCounselorRequests();
            window.location.reload(); // Refresh sessions
        } else {
            showNotification(data.message || 'An error occurred', 'error');
        }
    } catch (error) {
        console.error('Error handling request:', error);
        showNotification('Failed to process request', 'error');
    }
}

function declineRequest(appointmentId) {
    const reason = prompt('Please provide a reason for declining:');
    if (reason) {
        handleRequest(appointmentId, 'decline', { reason });
    }
}

function suggestAlternative(appointmentId) {
    const suggestion = prompt('Suggest why they should consider an alternative counselor:');
    if (suggestion) {
        handleRequest(appointmentId, 'suggest_alternative', { 
            suggestion_note: suggestion,
            alternative_counselor_id: null // Could be enhanced to select specific counselor
        });
    }
}

async function initiateCall(appointmentId, callType) {
    try {
        const response = await fetch('/api/counselor/call/initiate/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                appointment_id: appointmentId,
                call_type: callType
            })
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            showCallProgress(data.call_data, callType);
            currentCallId = appointmentId;
            startCallTimer();
        } else {
            showNotification(data.message || 'Failed to initiate call', 'error');
        }
    } catch (error) {
        console.error('Error initiating call:', error);
        showNotification('Failed to start call', 'error');
    }
}

function showCallProgress(callData, callType) {
    const modal = document.getElementById('callProgressModal');
    const title = document.getElementById('callTitle');
    const status = document.getElementById('callStatus');
    const details = document.getElementById('callDetails');
    
    title.textContent = `üìû ${callType === 'video_call' ? 'Video' : 'Voice'} Call in Progress`;
    status.textContent = 'Connected - Call in progress';
    details.innerHTML = `
        <strong>Session:</strong> ${callData.session_id}<br>
        ${callData.phone_number ? `<strong>Dial-in:</strong> ${callData.phone_number}<br>` : ''}
        ${callData.access_code ? `<strong>Access Code:</strong> ${callData.access_code}` : ''}
    `;
    
    modal.style.display = 'flex';
}

function startCallTimer() {
    callStartTime = Date.now();
    callTimer = setInterval(() => {
        const elapsed = Math.floor((Date.now() - callStartTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        document.getElementById('callTimer').textContent = 
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }, 1000);
}

function toggleMute() {
    isMuted = !isMuted;
    const btn = document.getElementById('muteBtn');
    btn.textContent = isMuted ? 'Unmute' : 'Mute';
    btn.className = isMuted ? 'counselor-btn counselor-btn-warning' : 'counselor-btn counselor-btn-secondary';
}

async function endCallSession() {
    if (!currentCallId) return;
    
    const duration = Math.floor((Date.now() - callStartTime) / 1000);
    
    try {
        const response = await fetch('/api/counselor/call/end/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                appointment_id: currentCallId,
                duration_seconds: duration,
                quality_rating: 5
            })
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            clearInterval(callTimer);
            document.getElementById('callProgressModal').style.display = 'none';
            showNotification(`Call ended. Duration: ${Math.floor(duration/60)}:${(duration%60).toString().padStart(2,'0')}`, 'success');
            currentCallId = null;
            window.location.reload();
        }
    } catch (error) {
        console.error('Error ending call:', error);
        showNotification('Error ending call', 'error');
    }
}

function endCall(appointmentId) {
    if (currentCallId === appointmentId) {
        endCallSession();
    }
}

function startSession(sessionId) {
    if (confirm('Are you sure you want to start this session?')) {
        showNotification('Session started successfully!', 'success');
    }
}

function rescheduleSession(sessionId) {
    showNotification('Reschedule feature coming soon!', 'info');
}

function viewNotes(sessionId) {
    showNotification('View notes feature coming soon!', 'info');
}

function editNotes(sessionId) {
    showNotification('Edit notes feature coming soon!', 'info');
}

function addSessionNote(sessionId) {
    const note = prompt('Add a session note:');
    if (note) {
        showNotification('Session note added!', 'success');
    }
}

function viewDetails(sessionId) {
    showNotification('View details feature coming soon!', 'info');
}

function filterSessions(filter) {
    const sessionCards = document.querySelectorAll('.counselor-session-card');
    sessionCards.forEach(card => {
        const status = card.getAttribute('data-status');
        let show = true;
        
        if (filter === 'all') {
            show = true;
        } else {
            show = status === filter;
        }
        
        card.style.display = show ? 'block' : 'none';
    });
}

function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `counselor-notification counselor-notification-${type}`;
    notification.innerHTML = `
        <div class="counselor-notification-content" style="display: flex; align-items: center; gap: 0.5rem; padding: 1rem; background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'}; color: white; border-radius: 0.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
            <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                ${type === 'success' ? 
                '<path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd"/>' :
                '<path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clipRule="evenodd"/>'}
            </svg>
            <span>${message}</span>
        </div>
    `;
    
    // Position notification
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 10001;
        transition: all 0.3s ease;
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// CSRF token helper
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
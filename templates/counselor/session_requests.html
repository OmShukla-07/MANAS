{% extends 'counselor/base_counselor_admin.html' %}

{% block title %}Session Requests - MANAS{% endblock %}

{% block content %}
<!-- Session Requests Header -->
<div style="background: linear-gradient(135deg, rgba(142, 224, 254, 0.1) 0%, rgba(255, 233, 180, 0.1) 100%); border: 1px solid rgba(142, 224, 254, 0.2); border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 2rem;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h3 style="font-size: 1.125rem; font-weight: 700; color: #0284c7; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                ðŸ‘¥ Students Requesting Sessions
            </h3>
            <p style="color: #0369a1; font-size: 0.875rem;">{{ session_requests|length }} student{{ session_requests|length|pluralize }} specifically requested you as their counselor</p>
        </div>
    </div>
</div>

<!-- Session Requests List -->
<div class="counselor-card-grid">
    {% for request in session_requests %}
    <div class="counselor-session-card">
        <div class="counselor-session-header">
            <div class="counselor-session-avatar">
                {{ request.student.first_name.0 }}{{ request.student.last_name.0 }}
            </div>
            <div class="counselor-session-info">
                <h4>{{ request.student.get_full_name }}</h4>
                <p>{{ request.student.email }}</p>
                <span style="background: rgba(245, 158, 11, 0.1); color: #d97706; padding: 0.25rem 0.5rem; border-radius: 0.375rem; font-size: 0.75rem; font-weight: 600;">
                    ðŸŽ¯ Requested You Specifically
                </span>
            </div>
            <span class="counselor-badge counselor-badge-pending">
                Pending
            </span>
        </div>
        
        <div class="counselor-session-details">
            <div class="counselor-detail-item">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                    <path fillRule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clipRule="evenodd"/>
                </svg>
                <span>{{ request.scheduled_date|date:"M d, Y" }}</span>
            </div>
            <div class="counselor-detail-item">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                    <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clipRule="evenodd"/>
                </svg>
                <span>{{ request.scheduled_time|time:"g:i A" }}</span>
            </div>
            <div class="counselor-detail-item">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
                    <path fillRule="evenodd" d="M4 5a2 2 0 012-2v1a2 2 0 00-2 2v6a2 2 0 002 2h10a2 2 0 002-2V6a2 2 0 00-2-2V3a2 2 0 012 2v6a4 4 0 01-4 4H6a4 4 0 01-4-4V5z" clipRule="evenodd"/>
                </svg>
                <span>{{ request.duration_minutes|default:"60" }} minutes</span>
            </div>
            <div class="counselor-detail-item">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                    {% if request.meeting_type == 'video_call' %}
                        <path d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14.553 7.106A1 1 0 0014 8v4a1 1 0 00.553.894l2 1A1 1 0 0018 13V7a1 1 0 00-1.447-.894l-2 1z"/>
                    {% elif request.meeting_type == 'phone_call' or request.meeting_type == 'voice_call' %}
                        <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"/>
                    {% else %}
                        <path d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z"/>
                    {% endif %}
                </svg>
                <span>{{ request.get_meeting_type_display|default:"In Person" }}</span>
            </div>
        </div>

        {% if request.reason %}
        <div class="counselor-session-notes">
            <h6>Reason for Session:</h6>
            <p>{{ request.reason|truncatechars:120 }}</p>
        </div>
        {% endif %}

        {% if request.preference_reason %}
        <div style="background: rgba(245, 158, 11, 0.1); padding: 0.75rem; border-radius: 0.375rem; margin: 1rem 0;">
            <h6 style="font-weight: 600; color: #d97706; margin-bottom: 0.5rem;">Why they chose you:</h6>
            <p style="font-size: 0.875rem; color: #92400e;">{{ request.preference_reason }}</p>
        </div>
        {% endif %}

        <!-- Additional Session Details -->
        <div class="counselor-session-notes">
            <h6>Session Details:</h6>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin: 0.5rem 0; font-size: 0.875rem;">
                <div><strong>Student ID:</strong> {{ request.student.id }}</div>
                <div><strong>Request Date:</strong> {{ request.created_at|date:"M d, Y H:i" }}</div>
                <div><strong>Priority:</strong> {{ request.priority|default:"Normal" }}</div>
                <div><strong>Status:</strong> {{ request.status|capfirst }}</div>
            </div>
        </div>

        <div class="counselor-session-actions">
            <button class="counselor-btn counselor-btn-success counselor-btn-sm" onclick="connectWithStudent('{{ request.id }}', '{{ request.student.get_full_name }}')">
                <svg width="14" height="14" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"/>
                </svg>
                Connect Session
            </button>
            <button class="counselor-btn counselor-btn-warning counselor-btn-sm" onclick="rescheduleRequest('{{ request.id }}')">
                <svg width="14" height="14" fill="currentColor" viewBox="0 0 20 20">
                    <path fillRule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clipRule="evenodd"/>
                </svg>
                Reschedule
            </button>
            <button class="counselor-btn counselor-btn-danger counselor-btn-sm" onclick="declineRequest('{{ request.id }}')">
                <svg width="14" height="14" fill="currentColor" viewBox="0 0 20 20">
                    <path fillRule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clipRule="evenodd"/>
                </svg>
                Decline
            </button>
        </div>
    </div>
    {% empty %}
    <div class="counselor-empty-state">
        <div class="counselor-empty-icon">
            <svg width="64" height="64" fill="currentColor" viewBox="0 0 20 20">
                <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"/>
            </svg>
        </div>
        <h4>No Session Requests</h4>
        <p>No students have specifically requested you as their counselor at this time.</p>
    </div>
    {% endfor %}
</div>

<!-- Connection Modal -->
<div id="connectionModal" class="counselor-modal" style="display: none;">
    <div class="counselor-modal-content">
        <div class="counselor-modal-header">
            <h3 id="connectionTitle">ðŸ”— Connecting Session</h3>
        </div>
        <div class="counselor-modal-body" style="text-align: center; padding: 2rem;">
            <div id="connectionStatus">
                <div style="margin-bottom: 1rem;">
                    <div style="width: 50px; height: 50px; border: 4px solid #e5e7eb; border-top: 4px solid #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem;"></div>
                    <p id="statusMessage">Connecting you with the student...</p>
                </div>
            </div>
            <div id="connectionResult" style="display: none;">
                <h4>âœ… Connection Successful!</h4>
                <p>Both you and the student are now connected to the session.</p>
                <div id="sessionDetails" style="background: #f0fdf4; padding: 1rem; border-radius: 0.5rem; margin: 1rem 0; border: 1px solid #bbf7d0;"></div>
            </div>
        </div>
    </div>
</div>

<style>
.counselor-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
}

.counselor-modal-content {
    background: white;
    border-radius: 0.75rem;
    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
    max-width: 500px;
    width: 90%;
}

.counselor-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem;
    border-bottom: 1px solid #e5e7eb;
}

.counselor-modal-body {
    padding: 1.5rem;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>

<script>
async function connectWithStudent(appointmentId, studentName) {
    // Show connection modal
    document.getElementById('connectionModal').style.display = 'flex';
    document.getElementById('statusMessage').textContent = `Connecting you with ${studentName}...`;
    
    try {
        const response = await fetch('/api/v1/core/api/connect-session/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                appointment_id: appointmentId
            })
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            // Hide loading, show success
            document.getElementById('connectionStatus').style.display = 'none';
            document.getElementById('connectionResult').style.display = 'block';
            
            // Show session details
            document.getElementById('sessionDetails').innerHTML = `
                <h5>Session Details:</h5>
                <p><strong>Student:</strong> ${data.session_data.student_name}</p>
                <p><strong>Date:</strong> ${data.session_data.scheduled_date}</p>
                <p><strong>Time:</strong> ${data.session_data.scheduled_time}</p>
                <p><strong>Type:</strong> ${data.session_data.meeting_type}</p>
                <p><strong>Session ID:</strong> ${data.session_data.session_id}</p>
                <p><strong>Redirecting to session room...</strong></p>
            `;
            
            // Auto close and redirect to session room
            setTimeout(() => {
                document.getElementById('connectionModal').style.display = 'none';
                window.location.href = data.session_data.redirect_url;
            }, 2000);
            
        } else {
            alert('Error: ' + (data.message || 'Failed to connect session'));
            document.getElementById('connectionModal').style.display = 'none';
        }
        
    } catch (error) {
        console.error('Connection error:', error);
        alert('Failed to connect session. Please try again.');
        document.getElementById('connectionModal').style.display = 'none';
    }
}

function rescheduleRequest(appointmentId) {
    if (confirm('Do you want to reschedule this session request?')) {
        showNotification('Reschedule feature will be available soon!', 'info');
    }
}

function declineRequest(appointmentId) {
    if (confirm('Are you sure you want to decline this session request?')) {
        showNotification('Decline feature will be available soon!', 'warning');
    }
}

function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : type === 'warning' ? '#f59e0b' : '#3b82f6'};
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 0.5rem;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10001;
        font-weight: 600;
        transition: all 0.3s ease;
    `;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// CSRF token helper
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Close modal when clicking outside
document.getElementById('connectionModal').addEventListener('click', function(e) {
    if (e.target === this) {
        this.style.display = 'none';
    }
});
</script>
{% endblock %}
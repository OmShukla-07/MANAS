{% extends 'counselor/base_counselor_admin.html' %}

{% block title %}Session Management - MANAS{% endblock %}

{% block content %}
<!-- Session Management Header -->
<div style="background: linear-gradient(135deg, rgba(142, 224, 254, 0.1) 0%, rgba(255, 233, 180, 0.1) 100%); border: 1px solid rgba(142, 224, 254, 0.2); border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 2rem;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h3 style="font-size: 1.125rem; font-weight: 700; color: #0284c7; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                ðŸ“… Complete Session Management Center
            </h3>
            <p style="color: #0369a1; font-size: 0.875rem;">Manage {{ stats.today_sessions|default:"8" }} sessions today â€¢ {{ stats.upcoming_sessions|default:"12" }} upcoming sessions â€¢ {{ session_requests|length|default:"3" }} pending requests</p>
        </div>
        <button style="background: linear-gradient(135deg, #8ee0fe 0%, #ffe9b4 100%); color: #0369a1; padding: 0.75rem 1.5rem; border-radius: 0.5rem; border: none; font-weight: 600; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; gap: 0.5rem;" 
                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(142, 224, 254, 0.3)'"
                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
            <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                <path d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z"/>
            </svg>
            Schedule Session
        </button>
    </div>
</div>

<!-- Session Statistics Overview -->
<div class="counselor-stats-grid">
    <div class="counselor-stat-card">
        <div class="counselor-stat-icon counselor-stat-icon-sessions">
            <svg width="24" height="24" fill="currentColor" viewBox="0 0 20 20">
                <path d="M10 2L3 7v11a2 2 0 002 2h4v-6h2v6h4a2 2 0 002-2V7l-7-5z"/>
            </svg>
        </div>
        <div class="counselor-stat-number">{{ stats.today_sessions|default:"8" }}</div>
        <div class="counselor-stat-label">Today's Sessions</div>
        <div class="counselor-stat-trend counselor-trend-up">+2 more than yesterday</div>
    </div>
    
    <div class="counselor-stat-card">
        <div class="counselor-stat-icon counselor-stat-icon-students">
            <svg width="24" height="24" fill="currentColor" viewBox="0 0 20 20">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
            </svg>
        </div>
        <div class="counselor-stat-number">{{ stats.upcoming_sessions|default:"12" }}</div>
        <div class="counselor-stat-label">Upcoming Sessions</div>
        <div class="counselor-stat-trend counselor-trend-up">Next 7 days</div>
    </div>
    
    <div class="counselor-stat-card">
        <div class="counselor-stat-icon counselor-stat-icon-requests">
            <svg width="24" height="24" fill="currentColor" viewBox="0 0 20 20">
                <path d="M9 6a3 3 0 11-6 0 3 3 0 616 0zM17 6a3 3 0 11-6 0 3 3 0 616 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 515 5v1H1v-1a5 5 0 515-5z"/>
            </svg>
        </div>
        <div class="counselor-stat-number">{{ session_requests|length|default:"3" }}</div>
        <div class="counselor-stat-label">Pending Requests</div>
        <div class="counselor-stat-trend counselor-trend-warning">Students requesting you</div>
    </div>
    
    <div class="counselor-stat-card">
        <div class="counselor-stat-icon counselor-stat-icon-crisis">
            <svg width="24" height="24" fill="currentColor" viewBox="0 0 20 20">
                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
                <path fillRule="evenodd" d="M4 5a2 2 0 012-2v1a2 2 0 00-2 2v6a2 2 0 002 2h10a2 2 0 002-2V6a2 2 0 00-2-2V3a2 2 0 012 2v6a4 4 0 01-4 4H6a4 4 0 01-4-4V5z" clipRule="evenodd"/>
            </svg>
        </div>
        <div class="counselor-stat-number">{{ stats.pending_notes|default:"3" }}</div>
        <div class="counselor-stat-label">Pending Notes</div>
        <div class="counselor-stat-trend counselor-trend-neutral">To be completed</div>
    </div>
</div>

<!-- Quick Actions & Filters -->
<div class="counselor-form-section">
    <div class="counselor-form-header">
        <h3>ðŸ“… Session Management</h3>
        <div class="counselor-header-actions">
            <button class="counselor-btn counselor-btn-primary" onclick="toggleFilters()">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                    <path fillRule="evenodd" d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.293.707L12 11.414V15a1 1 0 01-.293.707l-2 2A1 1 0 018 17v-5.586L3.293 6.707A1 1 0 013 6V3z" clipRule="evenodd"/>
                </svg>
                Filters
            </button>
            <button class="counselor-btn counselor-btn-success" onclick="scheduleNewSession()">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                    <path fillRule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clipRule="evenodd"/>
                </svg>
                New Session
            </button>
        </div>
    </div>
    
    <!-- Filter Section -->
    <div class="counselor-filter-section" id="filter-section" style="display: none;">
        <div class="counselor-filter-grid">
            <button class="counselor-filter-btn active" data-filter="all">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                    <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM4.332 8.027a6.012 6.012 0 011.912-2.706C6.512 5.73 6.974 6 7.5 6A1.5 1.5 0 019 7.5V8a2 2 0 004 0 2 2 0 011.523-1.943A5.977 5.977 0 0116 10c0 .34-.028.675-.083 1H15a2 2 0 00-2 2v2.197A5.973 5.973 0 0110 16v-2a2 2 0 00-2-2 2 2 0 01-2-2 2 2 0 00-1.668-1.973z" clipRule="evenodd"/>
                </svg>
                All Sessions
            </button>
            <button class="counselor-filter-btn" data-filter="requests">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9 6a3 3 0 11-6 0 3 3 0 616 0zM17 6a3 3 0 11-6 0 3 3 0 616 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 515 5v1H1v-1a5 5 0 515-5z"/>
                </svg>
                Pending Requests ({{ session_requests|length|default:"3" }})
            </button>
            <button class="counselor-filter-btn" data-filter="scheduled">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                    <path fillRule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clipRule="evenodd"/>
                </svg>
                Scheduled
            </button>
            <button class="counselor-filter-btn" data-filter="completed">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                    <path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd"/>
                </svg>
                Completed
            </button>
            <button class="counselor-filter-btn" data-filter="today">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                    <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clipRule="evenodd"/>
                </svg>
                Today
            </button>
        </div>
    </div>
</div>

<!-- Session Requests Section (Integrated) -->
<div id="session-requests-section" class="counselor-form-section">
    <div class="counselor-form-header">
        <h3>ðŸ‘¥ Pending Session Requests</h3>
        <div class="counselor-header-actions">
            <span class="counselor-badge counselor-badge-warning">{{ session_requests|length|default:"3" }} requests</span>
        </div>
    </div>
    
    <div class="counselor-card-grid" id="requests-container">
        {% for request in session_requests %}
        <div class="counselor-session-card" data-status="request" data-filter-type="requests">
            <div class="counselor-session-header">
                <div class="counselor-session-avatar">
                    {{ request.student.first_name.0 }}{{ request.student.last_name.0 }}
                </div>
                <div class="counselor-session-info">
                    <h4>{{ request.student.get_full_name }}</h4>
                    <p>{{ request.student.email }}</p>
                    <span style="background: rgba(245, 158, 11, 0.1); color: #d97706; padding: 0.25rem 0.5rem; border-radius: 0.375rem; font-size: 0.75rem; font-weight: 600;">
                        ðŸŽ¯ Requested You Specifically
                    </span>
                </div>
                <span class="counselor-badge counselor-badge-pending">
                    Pending Request
                </span>
            </div>
            
            <div class="counselor-session-details">
                <div class="counselor-detail-item">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                        <path fillRule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clipRule="evenodd"/>
                    </svg>
                    <span>{{ request.scheduled_date|date:"M d, Y" }}</span>
                </div>
                <div class="counselor-detail-item">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                        <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clipRule="evenodd"/>
                    </svg>
                    <span>{{ request.scheduled_time|time:"g:i A" }}</span>
                </div>
                <div class="counselor-detail-item">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
                        <path fillRule="evenodd" d="M4 5a2 2 0 012-2v1a2 2 0 00-2 2v6a2 2 0 002 2h10a2 2 0 002-2V6a2 2 0 00-2-2V3a2 2 0 012 2v6a4 4 0 01-4 4H6a4 4 0 01-4-4V5z" clipRule="evenodd"/>
                    </svg>
                    <span>{{ request.duration_minutes|default:"60" }} minutes</span>
                </div>
                <div class="counselor-detail-item">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                        {% if request.meeting_type == 'video_call' %}
                            <path d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14.553 7.106A1 1 0 0014 8v4a1 1 0 00.553.894l2 1A1 1 0 0018 13V7a1 1 0 00-1.447-.894l-2 1z"/>
                        {% elif request.meeting_type == 'phone_call' or request.meeting_type == 'voice_call' %}
                            <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"/>
                        {% else %}
                            <path d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z"/>
                        {% endif %}
                    </svg>
                    <span>{{ request.get_meeting_type_display|default:"In Person" }}</span>
                </div>
            </div>

            {% if request.reason %}
            <div class="counselor-session-notes">
                <h6>Reason for Session:</h6>
                <p>{{ request.reason|truncatechars:120 }}</p>
            </div>
            {% endif %}

            {% if request.preference_reason %}
            <div style="background: rgba(245, 158, 11, 0.1); padding: 0.75rem; border-radius: 0.375rem; margin: 1rem 0;">
                <h6 style="font-weight: 600; color: #d97706; margin-bottom: 0.5rem;">Why they chose you:</h6>
                <p style="font-size: 0.875rem; color: #92400e;">{{ request.preference_reason }}</p>
            </div>
            {% endif %}

            <!-- Additional Session Details -->
            <div class="counselor-session-notes">
                <h6>Request Details:</h6>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin: 0.5rem 0; font-size: 0.875rem;">
                    <div><strong>Student ID:</strong> {{ request.student.id }}</div>
                    <div><strong>Request Date:</strong> {{ request.created_at|date:"M d, Y H:i" }}</div>
                    <div><strong>Priority:</strong> {{ request.priority|default:"Normal" }}</div>
                    <div><strong>Status:</strong> {{ request.status|capfirst }}</div>
                </div>
            </div>

            <div class="counselor-session-actions">
                <button class="counselor-btn counselor-btn-success counselor-btn-sm" onclick="connectWithStudent('{{ request.id }}', '{{ request.student.get_full_name }}')">
                    <svg width="14" height="14" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"/>
                    </svg>
                    Connect Session
                </button>
                <button class="counselor-btn counselor-btn-warning counselor-btn-sm" onclick="rescheduleRequest('{{ request.id }}')">
                    <svg width="14" height="14" fill="currentColor" viewBox="0 0 20 20">
                        <path fillRule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clipRule="evenodd"/>
                    </svg>
                    Reschedule
                </button>
                <button class="counselor-btn counselor-btn-danger counselor-btn-sm" onclick="declineRequest('{{ request.id }}')">
                    <svg width="14" height="14" fill="currentColor" viewBox="0 0 20 20">
                        <path fillRule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clipRule="evenodd"/>
                    </svg>
                    Decline
                </button>
            </div>
        </div>
        {% empty %}
        <div class="counselor-empty-state" id="no-requests">
            <div class="counselor-empty-icon">
                <svg width="64" height="64" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9 6a3 3 0 11-6 0 3 3 0 616 0zM17 6a3 3 0 11-6 0 3 3 0 616 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 515 5v1H1v-1a5 5 0 515-5z"/>
                </svg>
            </div>
            <h4>No Session Requests</h4>
            <p>No students have specifically requested you as their counselor at this time.</p>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Regular Sessions List -->
<div id="regular-sessions-section" class="counselor-form-section">
    <div class="counselor-form-header">
        <h3>ðŸ“… Regular Sessions</h3>
    </div>
    
    <div class="counselor-card-grid" id="sessions-container">
        {% for session in sessions %}
        <div class="counselor-session-card" data-status="{{ session.status }}" data-filter-type="{{ session.status }}">
            <div class="counselor-session-header">
                <div class="counselor-session-avatar">
                    {{ session.student.first_name.0 }}{{ session.student.last_name.0 }}
                </div>
                <div class="counselor-session-info">
                    <h4>{{ session.student.get_full_name|default:"John Smith" }}</h4>
                    <p>{{ session.student.email|default:"john.smith@student.edu" }}</p>
                </div>
                <span class="counselor-badge counselor-badge-{{ session.status|default:'scheduled' }}">
                    {{ session.status|default:'Scheduled'|capfirst }}
                </span>
            </div>
            
            <div class="counselor-session-details">
                <div class="counselor-detail-item">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                        <path fillRule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clipRule="evenodd"/>
                    </svg>
                    <span>{{ session.scheduled_date|default:"Mar 25, 2025"|date:"M d, Y" }}</span>
                </div>
                <div class="counselor-detail-item">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                        <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clipRule="evenodd"/>
                    </svg>
                    <span>{{ session.scheduled_date|default:"10:30 AM"|time:"g:i A" }}</span>
                </div>
                <div class="counselor-detail-item">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
                        <path fillRule="evenodd" d="M4 5a2 2 0 012-2v1a2 2 0 00-2 2v6a2 2 0 002 2h10a2 2 0 002-2V6a2 2 0 00-2-2V3a2 2 0 012 2v6a4 4 0 01-4 4H6a4 4 0 01-4-4V5z" clipRule="evenodd"/>
                    </svg>
                    <span>{{ session.duration_minutes|default:"60" }} minutes</span>
                </div>
                <div class="counselor-detail-item">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                    </svg>
                    <span>{{ session.session_type|default:"Individual Counseling" }}</span>
                </div>
            </div>

            {% if session.notes %}
            <div class="counselor-session-notes">
                <h6>Session Notes</h6>
                <p>{{ session.notes|truncatechars:120|default:"Student shows good progress in managing anxiety. Working on coping strategies and stress management techniques." }}</p>
            </div>
            {% endif %}

            <div class="counselor-session-actions">
                {% if session.status == 'scheduled' %}
                    <button class="counselor-btn counselor-btn-primary counselor-btn-sm" onclick="startSession({{ session.id|default:'1' }})">
                        <svg width="14" height="14" fill="currentColor" viewBox="0 0 20 20">
                            <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clipRule="evenodd"/>
                        </svg>
                        Start Session
                    </button>
                    <button class="counselor-btn counselor-btn-warning counselor-btn-sm" onclick="rescheduleSession({{ session.id|default:'1' }})">
                        <svg width="14" height="14" fill="currentColor" viewBox="0 0 20 20">
                            <path fillRule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clipRule="evenodd"/>
                        </svg>
                        Reschedule
                    </button>
                {% elif session.status == 'completed' %}
                    <button class="counselor-btn counselor-btn-success counselor-btn-sm" onclick="viewNotes({{ session.id|default:'1' }})">
                        <svg width="14" height="14" fill="currentColor" viewBox="0 0 20 20">
                            <path fillRule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clipRule="evenodd"/>
                        </svg>
                        View Notes
                    </button>
                    <button class="counselor-btn counselor-btn-secondary counselor-btn-sm" onclick="editNotes({{ session.id|default:'1' }})">
                        <svg width="14" height="14" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.828-2.828z"/>
                        </svg>
                        Edit Notes
                    </button>
                {% endif %}
                <button class="counselor-btn counselor-btn-outline counselor-btn-sm" onclick="viewDetails({{ session.id|default:'1' }})">
                    <svg width="14" height="14" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/>
                        <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM4.332 8.027a6.012 6.012 0 011.912-2.706C6.512 5.73 6.974 6 7.5 6A1.5 1.5 0 019 7.5V8a2 2 0 004 0 2 2 0 011.523-1.943A5.977 5.977 0 0116 10c0 .34-.028.675-.083 1H15a2 2 0 00-2 2v2.197A5.973 5.973 0 0110 16v-2a2 2 0 00-2-2 2 2 0 01-2-2 2 2 0 00-1.668-1.973z" clipRule="evenodd"/>
                    </svg>
                    Details
                </button>
            </div>
        </div>
        {% empty %}
        <div class="counselor-empty-state" id="no-sessions">
            <div class="counselor-empty-icon">
                <svg width="64" height="64" fill="currentColor" viewBox="0 0 20 20">
                    <path fillRule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clipRule="evenodd"/>
                </svg>
            </div>
            <h4>No Sessions Found</h4>
            <p>You haven't scheduled any sessions yet. Start by creating your first session.</p>
            <button class="counselor-btn counselor-btn-primary" onclick="scheduleNewSession()">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                    <path fillRule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clipRule="evenodd"/>
                </svg>
                Schedule First Session
            </button>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Quick Calendar View -->
<div class="counselor-form-section counselor-mt-6">
    <div class="counselor-form-header">
        <h3>ðŸ“Š Weekly Overview</h3>
        <div class="counselor-header-actions">
            <button class="counselor-btn counselor-btn-secondary counselor-btn-sm" onclick="changeWeek(-1)">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                    <path fillRule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clipRule="evenodd"/>
                </svg>
                Previous
            </button>
            <button class="counselor-btn counselor-btn-secondary counselor-btn-sm" onclick="changeWeek(1)">
                Next
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                    <path fillRule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clipRule="evenodd"/>
                </svg>
            </button>
        </div>
    </div>
    
    <div class="counselor-calendar-grid">
        <div class="counselor-calendar-day">
            <div class="counselor-day-header">Monday<span>Mar 25</span></div>
            <div class="counselor-day-sessions">
                <div class="counselor-mini-session">10:00 AM - Sarah Johnson</div>
                <div class="counselor-mini-session">2:00 PM - Mike Chen</div>
            </div>
        </div>
        <div class="counselor-calendar-day">
            <div class="counselor-day-header">Tuesday<span>Mar 26</span></div>
            <div class="counselor-day-sessions">
                <div class="counselor-mini-session">11:00 AM - Emma Wilson</div>
            </div>
        </div>
        <div class="counselor-calendar-day">
            <div class="counselor-day-header">Wednesday<span>Mar 27</span></div>
            <div class="counselor-day-sessions">
                <div class="counselor-mini-session">9:00 AM - David Brown</div>
                <div class="counselor-mini-session">3:00 PM - Lisa Taylor</div>
                <div class="counselor-mini-session">4:30 PM - Alex Garcia</div>
            </div>
        </div>
        <div class="counselor-calendar-day">
            <div class="counselor-day-header">Thursday<span>Mar 28</span></div>
            <div class="counselor-day-sessions">
                <div class="counselor-mini-session">10:30 AM - Rachel Green</div>
            </div>
        </div>
        <div class="counselor-calendar-day">
            <div class="counselor-day-header">Friday<span>Mar 29</span></div>
            <div class="counselor-day-sessions">
                <div class="counselor-mini-session">1:00 PM - Tom Anderson</div>
                <div class="counselor-mini-session">2:30 PM - Nina Patel</div>
            </div>
        </div>
    </div>
</div>

<!-- Connection Modal -->
<div id="connectionModal" class="counselor-modal" style="display: none;">
    <div class="counselor-modal-content">
        <div class="counselor-modal-header">
            <h3 id="connectionTitle">ðŸ”— Connecting Session</h3>
        </div>
        <div class="counselor-modal-body" style="text-align: center; padding: 2rem;">
            <div id="connectionStatus">
                <div style="margin-bottom: 1rem;">
                    <div style="width: 50px; height: 50px; border: 4px solid #e5e7eb; border-top: 4px solid #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem;"></div>
                    <p id="statusMessage">Connecting you with the student...</p>
                </div>
            </div>
            <div id="connectionResult" style="display: none;">
                <h4>âœ… Connection Successful!</h4>
                <p>Both you and the student are now connected to the session.</p>
                <div id="sessionDetails" style="background: #f0fdf4; padding: 1rem; border-radius: 0.5rem; margin: 1rem 0; border: 1px solid #bbf7d0;"></div>
            </div>
        </div>
    </div>
</div>

<style>
.counselor-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
}

.counselor-modal-content {
    background: white;
    border-radius: 0.75rem;
    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
    max-width: 500px;
    width: 90%;
}

.counselor-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem;
    border-bottom: 1px solid #e5e7eb;
}

.counselor-modal-body {
    padding: 1.5rem;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Additional styles for integrated session management */
.counselor-stat-icon-requests {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    color: white;
}

.counselor-badge-pending {
    background: #fef3c7;
    color: #d97706;
}

.counselor-trend-warning {
    color: #d97706;
}

#session-requests-section {
    border: 2px solid #fef3c7;
    border-radius: 0.75rem;
    background: linear-gradient(135deg, rgba(245, 158, 11, 0.05) 0%, rgba(217, 119, 6, 0.05) 100%);
}

/* Notification styles */
.counselor-notification {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 10001;
    min-width: 300px;
    border-radius: 0.75rem;
    padding: 1rem;
    color: white;
    opacity: 1;
    transition: opacity 0.3s ease;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
}

.counselor-notification-success {
    background: linear-gradient(135deg, #22c55e, #16a34a);
}

.counselor-notification-info {
    background: linear-gradient(135deg, #3b82f6, #2563eb);
}

.counselor-notification-warning {
    background: linear-gradient(135deg, #f59e0b, #d97706);
}

.counselor-notification-content {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}
</style>

<script>
// Enhanced filter functionality for integrated session management
function toggleFilters() {
    const filterSection = document.getElementById('filter-section');
    filterSection.style.display = filterSection.style.display === 'none' ? 'block' : 'none';
}

function scheduleNewSession() {
    showNotification('Schedule Session feature coming soon!', 'info');
}

function startSession(sessionId) {
    if (confirm('Are you sure you want to start this session?')) {
        showNotification('Session started successfully!', 'success');
    }
}

function rescheduleSession(sessionId) {
    showNotification('Reschedule feature coming soon!', 'info');
}

function viewNotes(sessionId) {
    showNotification('View notes feature coming soon!', 'info');
}

function editNotes(sessionId) {
    showNotification('Edit notes feature coming soon!', 'info');
}

function viewDetails(sessionId) {
    showNotification('View details feature coming soon!', 'info');
}

function changeWeek(direction) {
    showNotification(`Loading ${direction > 0 ? 'next' : 'previous'} week...`, 'info');
}

// SESSION REQUEST FUNCTIONS (Integrated from session_requests.html)
async function connectWithStudent(appointmentId, studentName) {
    // Show connection modal
    document.getElementById('connectionModal').style.display = 'flex';
    document.getElementById('statusMessage').textContent = `Connecting you with ${studentName}...`;
    
    try {
        const response = await fetch('/api/v1/core/api/connect-session/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                appointment_id: appointmentId
            })
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            // Hide loading, show success
            document.getElementById('connectionStatus').style.display = 'none';
            document.getElementById('connectionResult').style.display = 'block';
            
            // Show session details
            document.getElementById('sessionDetails').innerHTML = `
                <h5>Session Details:</h5>
                <p><strong>Student:</strong> ${data.session_data.student_name}</p>
                <p><strong>Date:</strong> ${data.session_data.scheduled_date}</p>
                <p><strong>Time:</strong> ${data.session_data.scheduled_time}</p>
                <p><strong>Type:</strong> ${data.session_data.meeting_type}</p>
                <p><strong>Session ID:</strong> ${data.session_data.session_id}</p>
                <p><strong>Redirecting to session room...</strong></p>
            `;
            
            // Auto close and redirect to session room
            setTimeout(() => {
                document.getElementById('connectionModal').style.display = 'none';
                window.location.href = data.session_data.redirect_url;
            }, 2000);
            
        } else {
            alert('Error: ' + (data.message || 'Failed to connect session'));
            document.getElementById('connectionModal').style.display = 'none';
        }
        
    } catch (error) {
        console.error('Connection error:', error);
        alert('Failed to connect session. Please try again.');
        document.getElementById('connectionModal').style.display = 'none';
    }
}

function rescheduleRequest(appointmentId) {
    if (confirm('Do you want to reschedule this session request?')) {
        showNotification('Reschedule feature will be available soon!', 'info');
    }
}

function declineRequest(appointmentId) {
    if (confirm('Are you sure you want to decline this session request?')) {
        showNotification('Decline feature will be available soon!', 'warning');
    }
}

// Helper function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Enhanced filter functionality for integrated session management
document.addEventListener('DOMContentLoaded', function() {
    const filterBtns = document.querySelectorAll('.counselor-filter-btn');
    filterBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            // Remove active class from all buttons
            filterBtns.forEach(b => b.classList.remove('active'));
            // Add active class to clicked button
            this.classList.add('active');
            
            // Filter sessions
            const filter = this.getAttribute('data-filter');
            filterSessions(filter);
        });
    });
});

function filterSessions(filter) {
    const sessionCards = document.querySelectorAll('.counselor-session-card');
    const requestsSection = document.getElementById('session-requests-section');
    const regularSection = document.getElementById('regular-sessions-section');
    
    sessionCards.forEach(card => {
        const status = card.getAttribute('data-status');
        const filterType = card.getAttribute('data-filter-type');
        let show = true;
        
        if (filter === 'all') {
            show = true;
        } else if (filter === 'requests') {
            show = filterType === 'requests';
        } else if (filter === 'today') {
            // This would check if session is today - simplified for demo
            show = filterType !== 'requests';
        } else {
            show = status === filter || filterType === filter;
        }
        
        card.style.display = show ? 'block' : 'none';
    });
    
    // Show/hide sections based on filter
    if (filter === 'requests') {
        requestsSection.style.display = 'block';
        regularSection.style.display = 'none';
    } else if (filter === 'all') {
        requestsSection.style.display = 'block';
        regularSection.style.display = 'block';
    } else {
        requestsSection.style.display = 'none';
        regularSection.style.display = 'block';
    }
}

function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `counselor-notification counselor-notification-${type}`;
    notification.innerHTML = `
        <div class="counselor-notification-content">
            <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                ${type === 'success' ? 
                '<path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd"/>' :
                type === 'warning' ?
                '<path fillRule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clipRule="evenodd"/>' :
                '<path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clipRule="evenodd"/>'}
            </svg>
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.opacity = '0';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

function viewDetails(sessionId) {
    showNotification('View details feature coming soon!', 'info');
}

function changeWeek(direction) {
    showNotification(`Loading ${direction > 0 ? 'next' : 'previous'} week...`, 'info');
}

// Filter functionality
document.addEventListener('DOMContentLoaded', function() {
    const filterBtns = document.querySelectorAll('.counselor-filter-btn');
    filterBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            // Remove active class from all buttons
            filterBtns.forEach(b => b.classList.remove('active'));
            // Add active class to clicked button
            this.classList.add('active');
            
            // Filter sessions
            const filter = this.getAttribute('data-filter');
            filterSessions(filter);
        });
    });
});

function filterSessions(filter) {
    const sessionCards = document.querySelectorAll('.counselor-session-card');
    sessionCards.forEach(card => {
        const status = card.getAttribute('data-status');
        let show = true;
        
        if (filter === 'all') {
            show = true;
        } else if (filter === 'today') {
            // This would check if session is today - simplified for demo
            show = true;
        } else {
            show = status === filter;
        }
        
        card.style.display = show ? 'block' : 'none';
    });
}

function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `counselor-notification counselor-notification-${type}`;
    notification.innerHTML = `
        <div class="counselor-notification-content">
            <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                ${type === 'success' ? 
                '<path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd"/>' :
                '<path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clipRule="evenodd"/>'}
            </svg>
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.opacity = '0';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}
</script>
{% endblock %}